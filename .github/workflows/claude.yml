name: Claude Code

# ┌─────────────────────────────────────────────────────────────────────────────┐
# │                              WORKFLOW FLOW                                  │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │                                                                             │
# │  ISSUE                                                                      │
# │    │                                                                        │
# │    ├── @claude "question"        → claude (interactive, 15min)              │
# │    │                               └→ answers in comment                    │
# │    │                                                                        │
# │    └── /brainstorm "feature"     → brainstorm (interactive, 15min)          │
# │        │                           └→ asks Q&A (multiple rounds OK)         │
# │        │                                                                    │
# │        └── /answer "A, B, C"     → answer (interactive, 15min)              │
# │            │                                                                │
# │            ├── More questions?   → ask another round                        │
# │            │                                                                │
# │            └── All clear?        → create PR with brainstorm.md             │
# │                │                   PR suggests: 1) /plan 2) /draft 3) /lfg  │
# │                ▼                                                            │
# │  PR ◄──────────┘                                                            │
# │    │                                                                        │
# │    ├── /plan "details"           → plan (automation, 30min)                 │
# │    │                               └→ writes plan.md with research          │
# │    │                               └→ PR description suggests /work         │
# │    │                                                                        │
# │    ├── /draft "details"          → draft (automation, 15min)                │
# │    │                               └→ writes quick plan.md                  │
# │    │                               └→ PR description suggests /work         │
# │    │                                                                        │
# │    ├── /work                     → work (automation, 30min)                  │
# │    │                               └→ implements + changeset + review      │
# │    │                                                                        │
# │    ├── /review                   → review (automation, 30min)               │
# │    │                               └→ reviews code, creates P1/P2/P3 todos  │
# │    │                                                                        │
# │    ├── /resolve                  → resolve (automation, 30min)              │
# │    │                               └→ fixes P1/P2/P3 review findings        │
# │    │                                                                        │
# │    ├── /lfg "feature"            → lfg (automation, 60min, 200 turns)       │
# │    │                               └→ full autonomous: plan→work→review     │
# │    │                                                                        │
# │    └── /other-command            → slash-commands (automation, 30min)       │
# │                                    └→ reads .claude/commands/{cmd}.md       │
# │                                                                             │
# └─────────────────────────────────────────────────────────────────────────────┘

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  # Interactive mode - @claude mentions
  claude:
    if: |
      github.actor == 'zbeyens' && (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
        (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          trigger_phrase: '@claude'

          plugin_marketplaces: |
            https://github.com/EveryInc/compound-engineering-plugin.git
            https://github.com/udecode/dotai.git
          plugins: |
            compound-engineering@every-marketplace
            dig@dotai
            debug@dotai
            test@dotai

          claude_args: |
            --max-turns 100
            --allowedTools "Bash,Edit,Glob,Grep,Read,Task,Write,WebFetch,WebSearch,mcp__github_comment__update_claude_comment"
            --system-prompt "STRICTLY follow the command instructions without drifting. When you receive slash commands, first read .claude/commands/{command}.md and follow it exactly. Rules: /brainstorm - ask ALL questions at once with multiple choice options (A/B/C). DO NOT write files. Output brainstorm content and say 'Store at: docs/brainstorms/YYYY-MM-DD-topic-brainstorm.md', suggest next steps: 1) /plan 2) /draft 3) /lfg. /plan - DO NOT write files. Output plan content and say 'Store at: docs/plans/YYYY-MM-DD-type-topic-plan.md', suggest /work. /answer - read thread history, reload original command instructions, follow same rules."

          additional_permissions: |
            actions: read

  # Interactive mode - /brainstorm (Q&A first, then opens PR after answers)
  brainstorm:
    if: |
      github.actor == 'zbeyens' && (
        (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/brainstorm')) ||
        (github.event_name == 'pull_request_review_comment' && startsWith(github.event.comment.body, '/brainstorm'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          trigger_phrase: '/brainstorm'

          plugin_marketplaces: |
            https://github.com/EveryInc/compound-engineering-plugin.git
            https://github.com/udecode/dotai.git
          plugins: |
            compound-engineering@every-marketplace
            dig@dotai
            debug@dotai
            test@dotai

          claude_args: |
            --max-turns 100
            --allowedTools "Bash,Edit,Glob,Grep,Read,Task,Write,WebFetch,WebSearch,mcp__github_comment__update_claude_comment"
            --system-prompt "STRICTLY follow the command instructions without drifting. First read .claude/commands/brainstorm.md and follow it exactly. Ask ALL questions at once with multiple choice options (A/B/C). IF no questions needed (requirements are clear): create PR with description suggesting next steps: 1) /plan - plan with research 2) /draft - quick plan 3) /lfg - full autonomous. IF questions asked: wait for /answer to create PR."

          additional_permissions: |
            actions: read

  # Automation mode - /draft (quick plan to PR branch)
  draft:
    if: |
      github.actor == 'zbeyens' && (
        (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/draft')) ||
        (github.event_name == 'pull_request_review_comment' && startsWith(github.event.comment.body, '/draft'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          prompt: ${{ github.event.comment.body }}
          track_progress: true

          plugin_marketplaces: |
            https://github.com/EveryInc/compound-engineering-plugin.git
            https://github.com/udecode/dotai.git
          plugins: |
            compound-engineering@every-marketplace
            dig@dotai
            debug@dotai
            test@dotai

          claude_args: |
            --max-turns 100
            --allowedTools "Bash,Edit,Glob,Grep,Read,Task,Write,WebFetch,WebSearch,mcp__github_comment__update_claude_comment"
            --system-prompt "STRICTLY follow the command instructions without drifting. First read .claude/commands/draft.md and follow it exactly. Check PR for existing brainstorm file in docs/brainstorms/. After creating plan: 1) Write to docs/plans/YYYY-MM-DD-type-topic-plan.md 2) Commit and push to PR branch 3) Update PR description suggesting /work."

          additional_permissions: |
            actions: read

  # Automation mode - /plan (creates plan with research)
  plan:
    if: |
      github.actor == 'zbeyens' && (
        (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/plan')) ||
        (github.event_name == 'pull_request_review_comment' && startsWith(github.event.comment.body, '/plan'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          prompt: ${{ github.event.comment.body }}
          track_progress: true

          plugin_marketplaces: |
            https://github.com/EveryInc/compound-engineering-plugin.git
            https://github.com/udecode/dotai.git
          plugins: |
            compound-engineering@every-marketplace
            dig@dotai
            debug@dotai
            test@dotai

          claude_args: |
            --max-turns 100
            --allowedTools "Bash,Edit,Glob,Grep,Read,Task,Write,WebFetch,WebSearch,mcp__github_comment__update_claude_comment"
            --system-prompt "STRICTLY follow the command instructions without drifting. First read .claude/commands/plan.md and follow it exactly. Check PR for existing brainstorm file in docs/brainstorms/. After creating plan: 1) Write to docs/plans/YYYY-MM-DD-type-topic-plan.md 2) Commit and push to PR branch 3) Update PR description suggesting /work."

          additional_permissions: |
            actions: read

  # Interactive mode - /answer (continue previous command)
  answer:
    if: |
      github.actor == 'zbeyens' && (
        (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/answer')) ||
        (github.event_name == 'pull_request_review_comment' && startsWith(github.event.comment.body, '/answer'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          trigger_phrase: '/answer'

          plugin_marketplaces: |
            https://github.com/EveryInc/compound-engineering-plugin.git
            https://github.com/udecode/dotai.git
          plugins: |
            compound-engineering@every-marketplace
            dig@dotai
            debug@dotai
            test@dotai

          claude_args: |
            --max-turns 100
            --allowedTools "Bash,Edit,Glob,Grep,Read,Task,Write,WebFetch,WebSearch,mcp__github_comment__update_claude_comment"
            --system-prompt "STRICTLY follow the command instructions without drifting. This is a follow-up answer. First: read thread history to identify the original command. For /brainstorm follow-up: IF more questions needed, ask them (multiple rounds OK). IF all questions answered, THEN: 1) Write docs/brainstorms/YYYY-MM-DD-topic-brainstorm.md 2) Create branch feat/topic 3) Commit and push 4) Open PR with description suggesting next steps: 1) /plan - plan with research 2) /draft - quick plan 3) /lfg - full autonomous. For other commands: continue the conversation."

          additional_permissions: |
            actions: read

  # Automation mode - /work (implement changes based on plan)
  work:
    if: |
      github.actor == 'zbeyens' && (
        (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/work')) ||
        (github.event_name == 'pull_request_review_comment' && startsWith(github.event.comment.body, '/work'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          prompt: ${{ github.event.comment.body }}
          track_progress: true

          plugin_marketplaces: |
            https://github.com/EveryInc/compound-engineering-plugin.git
            https://github.com/udecode/dotai.git
          plugins: |
            compound-engineering@every-marketplace
            dig@dotai
            debug@dotai
            test@dotai

          claude_args: |
            --max-turns 100
            --allowedTools "Bash,Edit,Glob,Grep,Read,Task,Write,WebFetch,WebSearch,mcp__github_comment__update_claude_comment"
            --system-prompt "STRICTLY follow the command instructions without drifting. First read .claude/commands/work.md and follow it exactly. IMPORTANT: When running /review, output P1/P2/P3 todos in GitHub comment, do NOT write todo files."

          additional_permissions: |
            actions: read

  # Automation mode - /review (review code and create findings)
  review:
    if: |
      github.actor == 'zbeyens' && (
        (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/review')) ||
        (github.event_name == 'pull_request_review_comment' && startsWith(github.event.comment.body, '/review'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          prompt: ${{ github.event.comment.body }}
          track_progress: true

          plugin_marketplaces: |
            https://github.com/EveryInc/compound-engineering-plugin.git
            https://github.com/udecode/dotai.git
          plugins: |
            compound-engineering@every-marketplace
            dig@dotai
            debug@dotai
            test@dotai

          claude_args: |
            --max-turns 100
            --allowedTools "Bash,Edit,Glob,Grep,Read,Task,Write,WebFetch,WebSearch,mcp__github_comment__update_claude_comment"
            --system-prompt "STRICTLY follow the command instructions without drifting. First read .claude/commands/review.md and follow it exactly. IMPORTANT: Output P1/P2/P3 todos in GitHub comment, do NOT write todo files."

          additional_permissions: |
            actions: read

  # Automation mode - /resolve (fix todos from previous /review comment)
  resolve:
    if: |
      github.actor == 'zbeyens' && (
        (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/resolve')) ||
        (github.event_name == 'pull_request_review_comment' && startsWith(github.event.comment.body, '/resolve'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          prompt: ${{ github.event.comment.body }}
          track_progress: true

          plugin_marketplaces: |
            https://github.com/EveryInc/compound-engineering-plugin.git
            https://github.com/udecode/dotai.git
          plugins: |
            compound-engineering@every-marketplace
            dig@dotai
            debug@dotai
            test@dotai

          claude_args: |
            --max-turns 100
            --allowedTools "Bash,Edit,Glob,Grep,Read,Task,Write,WebFetch,WebSearch,mcp__github_comment__update_claude_comment"
            --system-prompt "STRICTLY follow the command instructions without drifting. Read thread history to find the previous /review comment containing todos (P1/P2/P3 findings). If no priority specified ('/resolve'), fix ALL priorities. If priorities specified ('/resolve P1 P2'), only fix those. For each todo: implement the fix, commit with conventional message. After all fixes: run typecheck, lint, test-browser."

          additional_permissions: |
            actions: read

  # Automation mode - /lfg (long-running autonomous workflow)
  lfg:
    if: |
      github.actor == 'zbeyens' && (
        (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/lfg')) ||
        (github.event_name == 'pull_request_review_comment' && startsWith(github.event.comment.body, '/lfg'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          prompt: ${{ github.event.comment.body }}
          track_progress: true

          plugin_marketplaces: |
            https://github.com/EveryInc/compound-engineering-plugin.git
            https://github.com/udecode/dotai.git
          plugins: |
            compound-engineering@every-marketplace
            dig@dotai
            debug@dotai
            test@dotai

          claude_args: |
            --max-turns 200
            --allowedTools "Bash,Edit,Glob,Grep,Read,Task,Write,WebFetch,WebSearch,mcp__github_comment__update_claude_comment"
            --system-prompt "STRICTLY follow the command instructions without drifting. First read .claude/commands/lfg.md and follow it exactly. IMPORTANT: When running /review, output P1/P2/P3 todos in GitHub comment, do NOT write todo files."

          additional_permissions: |
            actions: read

  # Automation mode - other /commands
  slash-commands:
    if: |
      github.actor == 'zbeyens' && (
        (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/') && !startsWith(github.event.comment.body, '/brainstorm') && !startsWith(github.event.comment.body, '/draft') && !startsWith(github.event.comment.body, '/plan') && !startsWith(github.event.comment.body, '/answer') && !startsWith(github.event.comment.body, '/work') && !startsWith(github.event.comment.body, '/review') && !startsWith(github.event.comment.body, '/resolve') && !startsWith(github.event.comment.body, '/lfg')) ||
        (github.event_name == 'pull_request_review_comment' && startsWith(github.event.comment.body, '/') && !startsWith(github.event.comment.body, '/brainstorm') && !startsWith(github.event.comment.body, '/draft') && !startsWith(github.event.comment.body, '/plan') && !startsWith(github.event.comment.body, '/answer') && !startsWith(github.event.comment.body, '/work') && !startsWith(github.event.comment.body, '/review') && !startsWith(github.event.comment.body, '/resolve') && !startsWith(github.event.comment.body, '/lfg'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          prompt: ${{ github.event.comment.body }}
          track_progress: true

          plugin_marketplaces: |
            https://github.com/EveryInc/compound-engineering-plugin.git
            https://github.com/udecode/dotai.git
          plugins: |
            compound-engineering@every-marketplace
            dig@dotai
            debug@dotai
            test@dotai

          claude_args: |
            --max-turns 100
            --allowedTools "Bash,Edit,Glob,Grep,Read,Task,Write,WebFetch,WebSearch,mcp__github_comment__update_claude_comment"
            --system-prompt "STRICTLY follow the command instructions without drifting. First read .claude/commands/{command}.md and follow it exactly."

          additional_permissions: |
            actions: read
