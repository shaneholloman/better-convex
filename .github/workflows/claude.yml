name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  # Interactive mode - @claude mentions
  claude:
    if: |
      github.actor == 'zbeyens' && (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
        (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache bun
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          trigger_phrase: '@claude'

          plugin_marketplaces: |
            https://github.com/EveryInc/compound-engineering-plugin.git
            https://github.com/udecode/dotai.git
          plugins: |
            compound-engineering@every-marketplace
            dig@dotai
            debug@dotai
            test@dotai

          claude_args: |
            --max-turns 1000
            --allowedTools "Bash,Edit,Glob,Grep,Read,Task,Write,WebFetch,WebSearch,mcp__github_comment__update_claude_comment"
            --system-prompt "STRICTLY follow the command instructions without drifting. When you receive slash commands, first read .claude/commands/{command}.md and follow it exactly. Rules: /brainstorm - ask ALL questions at once with multiple choice options (A/B/C). DO NOT write files. Output brainstorm content and say 'Store at: docs/brainstorms/YYYY-MM-DD-topic-brainstorm.md', suggest /dplan. /dplan - ask ALL questions at once. DO NOT write files. Output plan content and say 'Store at: docs/plans/YYYY-MM-DD-type-topic-plan.md', suggest /work. /answer - read thread history, reload original command instructions, follow same rules."

          additional_permissions: |
            actions: read

  # Interactive mode - /brainstorm
  brainstorm:
    if: |
      github.actor == 'zbeyens' && (
        (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/brainstorm')) ||
        (github.event_name == 'pull_request_review_comment' && startsWith(github.event.comment.body, '/brainstorm'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache bun
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          trigger_phrase: '/brainstorm'

          plugin_marketplaces: |
            https://github.com/EveryInc/compound-engineering-plugin.git
            https://github.com/udecode/dotai.git
          plugins: |
            compound-engineering@every-marketplace
            dig@dotai
            debug@dotai
            test@dotai

          claude_args: |
            --max-turns 1000
            --allowedTools "Bash,Edit,Glob,Grep,Read,Task,Write,WebFetch,WebSearch,mcp__github_comment__update_claude_comment"
            --system-prompt "STRICTLY follow the command instructions without drifting. First read .claude/commands/brainstorm.md and follow it exactly. Ask ALL questions at once with multiple choice options (A/B/C). DO NOT write files. Output brainstorm content and say 'Store at: docs/brainstorms/YYYY-MM-DD-topic-brainstorm.md', suggest /dplan."

          additional_permissions: |
            actions: read

  # Interactive mode - /plan
  plan:
    if: |
      github.actor == 'zbeyens' && (
        (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/plan')) ||
        (github.event_name == 'pull_request_review_comment' && startsWith(github.event.comment.body, '/plan'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache bun
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          trigger_phrase: '/plan'

          plugin_marketplaces: |
            https://github.com/EveryInc/compound-engineering-plugin.git
            https://github.com/udecode/dotai.git
          plugins: |
            compound-engineering@every-marketplace
            dig@dotai
            debug@dotai
            test@dotai

          claude_args: |
            --max-turns 1000
            --allowedTools "Bash,Edit,Glob,Grep,Read,Task,Write,WebFetch,WebSearch,mcp__github_comment__update_claude_comment"
            --system-prompt "STRICTLY follow the command instructions without drifting. First read .claude/commands/plan.md and follow it exactly. Check thread for existing brainstorm to use as input, otherwise gather requirements fresh. Ask ALL questions at once with options. DO NOT write files. Output plan content and say 'Store at: docs/plans/YYYY-MM-DD-type-topic-plan.md', suggest /work."

          additional_permissions: |
            actions: read

  # Interactive mode - /dplan
  dplan:
    if: |
      github.actor == 'zbeyens' && (
        (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/dplan')) ||
        (github.event_name == 'pull_request_review_comment' && startsWith(github.event.comment.body, '/dplan'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache bun
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          trigger_phrase: '/dplan'

          plugin_marketplaces: |
            https://github.com/EveryInc/compound-engineering-plugin.git
            https://github.com/udecode/dotai.git
          plugins: |
            compound-engineering@every-marketplace
            dig@dotai
            debug@dotai
            test@dotai

          claude_args: |
            --max-turns 1000
            --allowedTools "Bash,Edit,Glob,Grep,Read,Task,Write,WebFetch,WebSearch,mcp__github_comment__update_claude_comment"
            --system-prompt "STRICTLY follow the command instructions without drifting. First read .claude/commands/dplan.md and follow it exactly. Check thread for existing brainstorm to use as input, otherwise gather requirements fresh. Ask ALL questions at once with options. DO NOT write files. Output plan content and say 'Store at: docs/plans/YYYY-MM-DD-type-topic-plan.md', suggest /work."

          additional_permissions: |
            actions: read

  # Interactive mode - /answer (continue previous command)
  answer:
    if: |
      github.actor == 'zbeyens' && (
        (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/answer')) ||
        (github.event_name == 'pull_request_review_comment' && startsWith(github.event.comment.body, '/answer'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache bun
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          trigger_phrase: '/answer'

          plugin_marketplaces: |
            https://github.com/EveryInc/compound-engineering-plugin.git
            https://github.com/udecode/dotai.git
          plugins: |
            compound-engineering@every-marketplace
            dig@dotai
            debug@dotai
            test@dotai

          claude_args: |
            --max-turns 1000
            --allowedTools "Bash,Edit,Glob,Grep,Read,Task,Write,WebFetch,WebSearch,mcp__github_comment__update_claude_comment"
            --system-prompt "STRICTLY follow the command instructions without drifting. This is a follow-up answer. First: read thread history to identify the original command (/brainstorm, /plan, /dplan, etc). Then: Read .claude/commands/{command}.md and follow it exactly. DO NOT write files. For /brainstorm: output brainstorm content, say 'Store at: docs/brainstorms/YYYY-MM-DD-topic-brainstorm.md', suggest /dplan. For /plan or /dplan: output plan content, say 'Store at: docs/plans/YYYY-MM-DD-type-topic-plan.md', suggest /work."

          additional_permissions: |
            actions: read

  # Automation mode - /resolve (fix todos from previous /review comment)
  resolve:
    if: |
      github.actor == 'zbeyens' && (
        (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/resolve')) ||
        (github.event_name == 'pull_request_review_comment' && startsWith(github.event.comment.body, '/resolve'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache bun
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          prompt: ${{ github.event.comment.body }}
          track_progress: true

          plugin_marketplaces: |
            https://github.com/EveryInc/compound-engineering-plugin.git
            https://github.com/udecode/dotai.git
          plugins: |
            compound-engineering@every-marketplace
            dig@dotai
            debug@dotai
            test@dotai

          claude_args: |
            --max-turns 1000
            --allowedTools "Bash,Edit,Glob,Grep,Read,Task,Write,WebFetch,WebSearch,mcp__github_comment__update_claude_comment"
            --system-prompt "STRICTLY follow the command instructions without drifting. Read thread history to find the previous /review comment containing todos (P1/P2/P3 findings). If no priority specified ('/resolve'), fix ALL priorities. If priorities specified ('/resolve P1 P2'), only fix those. For each todo: implement the fix, commit with conventional message. After all fixes: run typecheck, lint, test-browser."

          additional_permissions: |
            actions: read

  # Automation mode - other /commands
  slash-commands:
    if: |
      github.actor == 'zbeyens' && (
        (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/') && !startsWith(github.event.comment.body, '/brainstorm') && !startsWith(github.event.comment.body, '/plan') && !startsWith(github.event.comment.body, '/dplan') && !startsWith(github.event.comment.body, '/answer') && !startsWith(github.event.comment.body, '/resolve')) ||
        (github.event_name == 'pull_request_review_comment' && startsWith(github.event.comment.body, '/') && !startsWith(github.event.comment.body, '/brainstorm') && !startsWith(github.event.comment.body, '/plan') && !startsWith(github.event.comment.body, '/dplan') && !startsWith(github.event.comment.body, '/answer') && !startsWith(github.event.comment.body, '/resolve'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache bun
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          prompt: ${{ github.event.comment.body }}
          track_progress: true

          plugin_marketplaces: |
            https://github.com/EveryInc/compound-engineering-plugin.git
            https://github.com/udecode/dotai.git
          plugins: |
            compound-engineering@every-marketplace
            dig@dotai
            debug@dotai
            test@dotai

          claude_args: |
            --max-turns 1000
            --allowedTools "Bash,Edit,Glob,Grep,Read,Task,Write,WebFetch,WebSearch,mcp__github_comment__update_claude_comment"
            --system-prompt "STRICTLY follow the command instructions without drifting. First read .claude/commands/{command}.md and follow it exactly."

          additional_permissions: |
            actions: read
