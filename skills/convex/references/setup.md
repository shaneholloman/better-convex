# Better Convex Setup (Canonical, Greenfield)

Use this runbook to set up a project from scratch so agents can ship features end-to-end without additional setup context.

## 1. Purpose and Scope

This document is the canonical setup reference for better-convex in `.claude`.

In scope:

- Greenfield setup from empty/new app
- ORM-first backend (`ctx.orm`)
- cRPC setup, auth setup, client setup, framework setup
- Optional modules and plugin setup gates

Out of scope:

- Migrations from existing Convex/Ents/legacy data-layer projects

If migration is needed, stop and use migration docs separately. Do not mix migration steps into this runbook.

## 2. Agent Decision Intake

This is the **mandatory first prompt** for agents helping users set up better-convex.
Ask these questions before editing files.

### 2.1 Ask These First (match `/www/content/docs/index.mdx`)

#### Required choices

| Feature | Options | Default |
| --- | --- | --- |
| Approach | Top-down (copy from Templates), Bottom-up (follow docs step-by-step) | Top-down |
| React Framework | Next.js App Router, TanStack Start, Other | Next.js App Router |
| Database | ORM (`ctx.orm`) | ORM |

#### Optional features

| Feature | Options | When to include |
| --- | --- | --- |
| Auth | Better Auth, Custom, None | Most apps need auth |
| SSR/RSC | Yes, No | Next.js App Router apps |
| Triggers | Yes, No | Auto side effects on data changes |
| Aggregates | Yes, No | Counts, sums, leaderboards |
| Rate Limiting | Yes, No | API protection |
| Scheduling | Yes, No | Background jobs, delayed tasks |
| HTTP router | Yes, No | REST/webhook style endpoints |
| RLS | Yes, No | Runtime row-level access control |
| Auth plugins | admin, organizations, polar, none | Only when product requires them |

### 2.2 First Prompt Template

Use this exact structure:

1. Approach: Top-down templates or bottom-up docs?
2. Framework: Next.js App Router, TanStack Start, or other?
3. Auth: Better Auth, custom auth, or no auth?
4. Need SSR/RSC?
5. Enable triggers?
6. Enable aggregates?
7. Enable rate limiting?
8. Enable scheduling?
9. Need HTTP router endpoints?
10. Enable RLS?
11. Any auth plugins (admin/organizations/polar)?

### 2.3 Decision Mapping

Map answers to setup execution in this order:

1. Build base setup first.
2. Add auth core only if auth is enabled.
3. Add framework branch (Next.js or TanStack Start).
4. Add optional modules/plugins only when selected.
5. If framework is `Other`, stop this runbook and route to non-setup docs (`react`, `server/*`) instead of guessing.

## 3. Base Bootstrap

### 3.1 Create app and install baseline packages

```bash
bunx create-next-app@latest my-app --typescript --tailwind --eslint --app --src-dir
cd my-app
bun add convex better-convex zod @tanstack/react-query
```

### 3.2 Create baseline folders

```bash
mkdir -p convex/functions convex/lib convex/shared src/lib/convex
```

If the goal is to recreate the full `example/convex` backend shape, also scaffold:

```bash
mkdir -p convex/functions/items convex/lib/auth convex/lib/emails convex/routers
```

Recommended monolithic structure:

```text
src/                    # app/client
convex/functions/       # deployed Convex functions
convex/lib/             # backend helpers (not deployed as API)
convex/shared/          # shared types/meta imported by client
```

### 3.3 Configure Convex functions path and static codegen

**Create:** `convex.json`

```json
{
  "functions": "convex/functions",
  "codegen": {
    "staticApi": true,
    "staticDataModel": true
  }
}
```

### 3.4 Configure TypeScript aliases and strict function typing

**Edit:** `tsconfig.json`

```json
{
  "compilerOptions": {
    "strict": true,
    "strictFunctionTypes": false,
    "paths": {
      "@/*": ["./src/*"],
      "@convex/*": ["./convex/functions/_generated/*", "./convex/shared/*"]
    }
  }
}
```

### 3.5 Enforce import boundaries (recommended)

Use Biome/Ultracite rules so:

- `src/` can import from `@convex/*` only
- `src/` cannot import `convex/functions` or `convex/lib` directly
- `convex/` cannot import from `src/`

## 4. Environment Variables

### 4.1 Local

**Create:** `.env.local`

```bash
# Convex WebSocket API
NEXT_PUBLIC_CONVEX_URL=http://localhost:3210

# Convex HTTP site URL
NEXT_PUBLIC_CONVEX_SITE_URL=http://localhost:3211

# App URL for Better Auth client
NEXT_PUBLIC_SITE_URL=http://localhost:3000
```

### 4.2 Cloud

```bash
# Generated by Convex
NEXT_PUBLIC_CONVEX_URL=https://your-project.convex.cloud

# Must be set manually
NEXT_PUBLIC_CONVEX_SITE_URL=https://your-project.convex.site

NEXT_PUBLIC_SITE_URL=http://localhost:3000
```

Rule: real-time URL uses `.cloud`; HTTP/router/caller URL uses `.site`.

### 4.3 Typed env helper (recommended for full backend parity)

When multiple Convex functions and libs share env values (auth, billing, dev guards), create one typed helper:

**Create:** `convex/lib/get-env.ts`

```ts
import { createEnv } from "better-convex/server";
import { z } from "zod";

export const getEnv = createEnv({
  schema: z.object({
    DEPLOY_ENV: z.string().default("production"),
    SITE_URL: z.string().default("http://localhost:3000"),
    BETTER_AUTH_SECRET: z.string(),
    JWKS: z.string().optional(),
    ADMIN: z
      .string()
      .default("")
      .transform((s) => (s ? s.split(",") : []))
      .pipe(z.array(z.string())),
    RESEND_API_KEY: z.string().optional(),
    POLAR_ACCESS_TOKEN: z.string().optional(),
    POLAR_SERVER: z.enum(["production", "sandbox"]).default("sandbox"),
    POLAR_PRODUCT_PREMIUM: z.string().optional(),
    POLAR_WEBHOOK_SECRET: z.string().optional(),
  }),
});
```

Then prefer `getEnv()` in Convex code instead of scattered `process.env`.

## 5. Core Backend

### 5.1 Define schema and relations

**Create:** `convex/functions/schema.ts`

```ts
import {
  boolean,
  convexTable,
  defineRelations,
  defineSchema,
  id,
  index,
  text,
  timestamp,
} from "better-convex/orm";

export const user = convexTable(
  "user",
  {
    name: text().notNull(),
    email: text().notNull(),
    emailVerified: boolean().notNull().default(false),
    image: text(),
    createdAt: timestamp().notNull().defaultNow(),
    updatedAt: timestamp().notNull(),
  },
  (t) => [index("email").on(t.email)]
);

export const project = convexTable(
  "project",
  {
    name: text().notNull(),
    ownerId: id("user").notNull(),
    createdAt: timestamp().notNull().defaultNow(),
    updatedAt: timestamp().notNull(),
  },
  (t) => [index("ownerId_createdAt").on(t.ownerId, t.createdAt)]
);

export const tables = { user, project };

export default defineSchema(tables, { strict: false });

export const relations = defineRelations(tables, (r) => ({
  user: {
    projects: r.many.project(),
  },
  project: {
    owner: r.one.user({ from: r.project.ownerId, to: r.user.id }),
  },
}));
```

### 5.2 Attach ORM once (`ctx.orm`)

**Create:** `convex/lib/orm.ts`

```ts
import { createOrm, type GenericOrmCtx } from "better-convex/orm";

import type { MutationCtx, QueryCtx } from "../functions/_generated/server";
import { relations } from "../functions/schema";

const orm = createOrm({ schema: relations });

export type OrmCtx<Ctx extends QueryCtx | MutationCtx = QueryCtx> =
  GenericOrmCtx<Ctx, typeof relations>;

export function withOrm<Ctx extends QueryCtx | MutationCtx>(ctx: Ctx) {
  return { ...ctx, orm: orm.db(ctx) } as OrmCtx<Ctx>;
}
```

### 5.3 Initialize cRPC and procedure builders

**Create:** `convex/lib/crpc.ts`

```ts
import { getHeaders } from "better-convex/auth";
import { CRPCError, initCRPC } from "better-convex/server";

import type { DataModel } from "../functions/_generated/dataModel";
import { getAuth } from "../functions/auth";
import { withOrm } from "./orm";

type Meta = {
  auth?: "optional" | "required";
  role?: "admin";
  rateLimit?: string;
};

const c = initCRPC
  .dataModel<DataModel>()
  .context({
    query: (ctx) => withOrm(ctx),
    mutation: (ctx) => withOrm(ctx),
  })
  .meta<Meta>()
  .create();

const authMiddleware = c.middleware(async ({ ctx, next }) => {
  const auth = getAuth(ctx);
  const session = await auth.api.getSession({ headers: await getHeaders(ctx) });

  if (!session?.user) {
    throw new CRPCError({ code: "UNAUTHORIZED" });
  }

  return next({
    ctx: {
      ...ctx,
      user: session.user,
      userId: session.user.id,
    },
  });
});

const roleMiddleware = c.middleware(({ meta, ctx, next }) => {
  if (meta.role !== "admin") return next({ ctx });

  const user = (ctx as { user?: { role?: string | null } }).user;
  if (user?.role !== "admin") {
    throw new CRPCError({
      code: "FORBIDDEN",
      message: "Admin access required",
    });
  }

  return next({ ctx });
});

export const publicQuery = c.query;
export const publicMutation = c.mutation;
export const publicAction = c.action;

export const privateQuery = c.query.internal();
export const privateMutation = c.mutation.internal();
export const privateAction = c.action.internal();

export const authQuery = c.query.use(authMiddleware).use(roleMiddleware);
export const authMutation = c.mutation.use(authMiddleware).use(roleMiddleware);
export const authAction = c.action.use(authMiddleware);

export const publicRoute = c.httpAction;
export const router = c.router;
```

### 5.4 Shared API/type helpers

**Create:** `convex/shared/types.ts`

```ts
import type { InferInsertModel, InferSelectModel } from "better-convex/orm";
import type {
  inferApiInputs,
  inferApiOutputs,
  WithHttpRouter,
} from "better-convex/server";

import type { api } from "../functions/_generated/api";
import type { appRouter } from "../functions/http";
import type { tables } from "../functions/schema";

export type TableName = keyof typeof tables;
export type Select<T extends TableName> = InferSelectModel<(typeof tables)[T]>;
export type Insert<T extends TableName> = InferInsertModel<(typeof tables)[T]>;

export type Api = WithHttpRouter<typeof api, typeof appRouter>;
export type ApiInputs = inferApiInputs<Api>;
export type ApiOutputs = inferApiOutputs<Api>;
```

### 5.5 Start dev/codegen

```bash
bunx better-convex dev
```

This generates:

- `convex/functions/_generated/*`
- `convex/shared/meta.ts`

One-time codegen:

```bash
bunx better-convex codegen
```

## 6. Auth Core (Better Auth)

Feature gate: only apply this section if auth is enabled.

### 6.1 Install auth dependencies

```bash
bun add better-auth@1.4.9 better-convex hono
```

### 6.2 Auth config provider

**Create:** `convex/functions/auth.config.ts`

```ts
import { getAuthConfigProvider } from "better-convex/auth-config";
import type { AuthConfig } from "convex/server";

export default {
  providers: [getAuthConfigProvider({ jwks: process.env.JWKS })],
} satisfies AuthConfig;
```

### 6.3 Define auth tables in schema

Add these tables if not already present:

- `user`
- `session`
- `account`
- `verification`
- `jwks`

Keep all auth reads/writes on ORM table definitions in `convex/functions/schema.ts`.

### 6.4 Create auth client and options

**Create:** `convex/functions/auth.ts`

```ts
import { type BetterAuthOptions, betterAuth } from "better-auth";
import { admin } from "better-auth/plugins";
import {
  type AuthFunctions,
  convex,
  createApi,
  createClient,
} from "better-convex/auth";

import { type OrmCtx, withOrm } from "../lib/orm";
import { internal } from "./_generated/api";
import type { DataModel } from "./_generated/dataModel";
import type { ActionCtx, MutationCtx, QueryCtx } from "./_generated/server";
import authConfig from "./auth.config";
import schema from "./schema";

type GenericCtx = QueryCtx | MutationCtx | ActionCtx;

type OrmMutationCtx = OrmCtx<MutationCtx>;

const authFunctions: AuthFunctions = internal.auth;

export const authClient = createClient<
  DataModel,
  typeof schema,
  OrmMutationCtx
>({
  authFunctions,
  schema,
  context: withOrm,
});

export const getAuthOptions = (ctx: GenericCtx) =>
  ({
    baseURL: process.env.SITE_URL!,
    database: authClient.adapter(ctx, getAuthOptions),
    plugins: [
      admin(),
      convex({
        authConfig,
        jwks: process.env.JWKS,
      }),
    ],
    session: {
      expiresIn: 60 * 60 * 24 * 30,
      updateAge: 60 * 60 * 24 * 15,
    },
    trustedOrigins: [process.env.SITE_URL ?? "http://localhost:3000"],
  }) satisfies BetterAuthOptions;

export const getAuth = (ctx: GenericCtx) => betterAuth(getAuthOptions(ctx));

export const {
  beforeCreate,
  beforeDelete,
  beforeUpdate,
  onCreate,
  onDelete,
  onUpdate,
} = authClient.triggersApi();

export const {
  create,
  deleteMany,
  deleteOne,
  findMany,
  findOne,
  updateMany,
  updateOne,
  getLatestJwks,
  rotateKeys,
} = createApi(schema, getAuth, {
  context: withOrm,
  skipValidation: true,
});

// biome-ignore lint/suspicious/noExplicitAny: required for CLI schema tooling
export const auth = betterAuth(getAuthOptions({} as any));
```

Canonical rule: always use `getAuth(ctx)` + `authClient.adapter(ctx, getAuthOptions)`.

### 6.5 Required polyfill for auth HTTP runtime

**Create:** `convex/lib/http-polyfills.ts`

```ts
if (typeof MessageChannel === "undefined") {
  class MockMessagePort {
    onmessage: ((ev: MessageEvent) => void) | undefined;
    onmessageerror: ((ev: MessageEvent) => void) | undefined;

    addEventListener() {}
    close() {}
    dispatchEvent(_event: Event): boolean {
      return false;
    }
    postMessage(_message: unknown, _transfer: Transferable[] = []) {}
    removeEventListener() {}
    start() {}
  }

  class MockMessageChannel {
    port1: MockMessagePort;
    port2: MockMessagePort;

    constructor() {
      this.port1 = new MockMessagePort();
      this.port2 = new MockMessagePort();
    }
  }

  globalThis.MessageChannel =
    MockMessageChannel as unknown as typeof MessageChannel;
}
```

### 6.6 Register auth HTTP routes

**Create:** `convex/functions/http.ts`

cRPC + Hono route shape:

```ts
import "../lib/http-polyfills";

import { authMiddleware } from "better-convex/auth";
import { createHttpRouter } from "better-convex/server";
import { Hono } from "hono";
import { cors } from "hono/cors";

import { router } from "../lib/crpc";
import { getAuth } from "./auth";

const app = new Hono();

app.use(
  "/api/*",
  cors({
    origin: process.env.SITE_URL!,
    allowHeaders: ["Content-Type", "Authorization", "Better-Auth-Cookie"],
    exposeHeaders: ["Set-Better-Auth-Cookie"],
    credentials: true,
  })
);

app.use(authMiddleware(getAuth));

export const appRouter = router({
  // register routers here
});

export default createHttpRouter(app, appRouter);
```

### 6.7 Sync env and JWKS

**Create:** `convex/.env`

```bash
SITE_URL=http://localhost:3000
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
```

Sync:

```bash
bunx better-convex env sync --auth
```

Rotate later:

```bash
bunx convex run auth:rotateKeys | bunx convex env set JWKS
```

### 6.8 Production bootstrap notes

First prod deploy requires JWKS initialization:

```bash
bunx convex deploy --prod
bunx convex run auth:getLatestJwks --prod | bunx convex env set JWKS --prod
```

## 7. Client Core

### 7.1 Auth client setup

**Create:** `src/lib/convex/auth-client.ts`

```ts
import type { Auth } from "@convex/auth-shared";
import { adminClient, inferAdditionalFields } from "better-auth/client/plugins";
import { createAuthClient } from "better-auth/react";
import { convexClient } from "better-convex/auth-client";
import { createAuthMutations } from "better-convex/react";

export const authClient = createAuthClient({
  baseURL: process.env.NEXT_PUBLIC_SITE_URL!,
  sessionOptions: {
    refetchOnWindowFocus: false,
  },
  plugins: [inferAdditionalFields<Auth>(), adminClient(), convexClient()],
});

export const {
  useSignOutMutationOptions,
  useSignInSocialMutationOptions,
  useSignInMutationOptions,
  useSignUpMutationOptions,
} = createAuthMutations(authClient);
```

### 7.2 QueryClient setup

**Create:** `src/lib/convex/query-client.ts`

```ts
import {
  type DefaultOptions,
  defaultShouldDehydrateQuery,
  QueryCache,
  QueryClient,
} from "@tanstack/react-query";
import { isCRPCClientError, isCRPCError } from "better-convex/crpc";
import SuperJSON from "superjson";

export const hydrationConfig: Pick<DefaultOptions, "dehydrate" | "hydrate"> = {
  dehydrate: {
    serializeData: SuperJSON.serialize,
    shouldDehydrateQuery: (query) =>
      defaultShouldDehydrateQuery(query) || query.state.status === "pending",
    shouldRedactErrors: () => false,
  },
  hydrate: {
    deserializeData: SuperJSON.deserialize,
  },
};

export function createQueryClient() {
  return new QueryClient({
    queryCache: new QueryCache({
      onError: (error) => {
        if (isCRPCClientError(error)) {
          console.warn(`[CRPC] ${error.code}:`, error.functionName);
        }
      },
    }),
    defaultOptions: {
      ...hydrationConfig,
      queries: {
        retry: (failureCount, error) => {
          if (isCRPCError(error)) return false;
          return failureCount < 3;
        },
      },
    },
  });
}
```

### 7.3 cRPC React context

**Create:** `src/lib/convex/crpc.tsx`

```tsx
import { api } from "@convex/api";
import { meta } from "@convex/meta";
import type { Api } from "@convex/types";
import { createCRPCContext } from "better-convex/react";

export const { CRPCProvider, useCRPC, useCRPCClient } = createCRPCContext<Api>({
  api,
  meta,
  convexSiteUrl: process.env.NEXT_PUBLIC_CONVEX_SITE_URL!,
});
```

### 7.4 Provider composition

**Create:** `src/lib/convex/convex-provider.tsx`

```tsx
"use client";

import { QueryClientProvider as TanstackQueryClientProvider } from "@tanstack/react-query";
import { ConvexAuthProvider } from "better-convex/auth-client";
import {
  ConvexReactClient,
  getConvexQueryClientSingleton,
  getQueryClientSingleton,
  useAuthStore,
} from "better-convex/react";
import type { ReactNode } from "react";

import { authClient } from "./auth-client";
import { CRPCProvider } from "./crpc";
import { createQueryClient } from "./query-client";

const convex = new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

export function BetterConvexProvider({
  children,
  token,
}: {
  children: ReactNode;
  token?: string;
}) {
  return (
    <ConvexAuthProvider
      authClient={authClient}
      client={convex}
      initialToken={token}
    >
      <QueryProvider>{children}</QueryProvider>
    </ConvexAuthProvider>
  );
}

function QueryProvider({ children }: { children: ReactNode }) {
  const authStore = useAuthStore();

  const queryClient = getQueryClientSingleton(createQueryClient);
  const convexQueryClient = getConvexQueryClientSingleton({
    authStore,
    convex,
    queryClient,
  });

  return (
    <TanstackQueryClientProvider client={queryClient}>
      <CRPCProvider convexClient={convex} convexQueryClient={convexQueryClient}>
        {children}
      </CRPCProvider>
    </TanstackQueryClientProvider>
  );
}
```

## 8. Framework-Specific Setup

## 8.A Next.js App Router

### 8.A.1 Server caller + auth utilities

**Create:** `src/lib/convex/server.ts`

```ts
import { api } from "@convex/api";
import { meta } from "@convex/meta";
import { convexBetterAuth } from "better-convex/auth-nextjs";

export const { createContext, createCaller, handler } = convexBetterAuth({
  api,
  convexSiteUrl: process.env.NEXT_PUBLIC_CONVEX_SITE_URL!,
  meta,
});
```

### 8.A.2 Auth API route

**Create:** `src/app/api/auth/[...all]/route.ts`

```ts
import { handler } from "@/lib/convex/server";

export const { GET, POST } = handler;
```

### 8.A.3 RSC helpers

**Create:** `src/lib/convex/rsc.tsx`

```tsx
import "server-only";

import { api } from "@convex/api";
import { meta } from "@convex/meta";
import type { Api } from "@convex/types";
import type { FetchQueryOptions } from "@tanstack/react-query";
import {
  dehydrate,
  HydrationBoundary,
  QueryClient,
} from "@tanstack/react-query";
import {
  createServerCRPCProxy,
  getServerQueryClientOptions,
} from "better-convex/rsc";
import { headers } from "next/headers";
import { cache } from "react";

import { hydrationConfig } from "./query-client";
import { createCaller, createContext } from "./server";

const createRSCContext = cache(async () =>
  createContext({ headers: await headers() })
);

export const caller = createCaller(createRSCContext);
export const crpc = createServerCRPCProxy<Api>({ api, meta });

function createServerQueryClient() {
  return new QueryClient({
    defaultOptions: {
      ...hydrationConfig,
      ...getServerQueryClientOptions({
        getToken: caller.getToken,
        convexSiteUrl: process.env.NEXT_PUBLIC_CONVEX_SITE_URL!,
      }),
    },
  });
}

export const getQueryClient = cache(createServerQueryClient);

export function prefetch<T extends { queryKey: readonly unknown[] }>(
  queryOptions: T
): void {
  void getQueryClient().prefetchQuery(queryOptions);
}

export function preloadQuery<
  TQueryFnData = unknown,
  TError = Error,
  TData = TQueryFnData,
  TQueryKey extends readonly unknown[] = readonly unknown[],
>(
  options: FetchQueryOptions<TQueryFnData, TError, TData, TQueryKey>
): Promise<TData> {
  return getQueryClient().fetchQuery(options);
}

export function HydrateClient({ children }: { children: React.ReactNode }) {
  const queryClient = getQueryClient();
  const dehydratedState = dehydrate(queryClient);

  return (
    <HydrationBoundary state={dehydratedState}>{children}</HydrationBoundary>
  );
}
```

### 8.A.4 Pass server token to provider

```tsx
// app/(app)/layout.tsx
import { BetterConvexProvider } from "@/lib/convex/convex-provider";
import { caller } from "@/lib/convex/rsc";

export default async function AppLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const token = await caller.getToken();
  return <BetterConvexProvider token={token}>{children}</BetterConvexProvider>;
}
```

## 8.B TanStack Start

Explicit exception: current docs still use `@convex-dev/better-auth/*` helpers for TanStack Start integration.

### 8.B.1 Auth client + auth server helpers

**Create:** `src/lib/convex/auth/auth-client.ts`

```ts
import type { Auth } from "@convex/auth-shared";
import { convexClient } from "@convex-dev/better-auth/client/plugins";
import { adminClient, inferAdditionalFields } from "better-auth/client/plugins";
import { createAuthClient } from "better-auth/react";

export const authClient = createAuthClient({
  baseURL:
    typeof window === "undefined"
      ? (import.meta.env.VITE_SITE_URL as string | undefined)
      : window.location.origin,
  sessionOptions: { refetchOnWindowFocus: false },
  plugins: [inferAdditionalFields<Auth>(), adminClient(), convexClient()],
});
```

**Create:** `src/lib/convex/auth/auth-server.ts`

```ts
import { convexBetterAuthReactStart } from "@convex-dev/better-auth/react-start";

export const {
  handler,
  getToken,
  fetchAuthQuery,
  fetchAuthMutation,
  fetchAuthAction,
} = convexBetterAuthReactStart({
  convexUrl: process.env.VITE_CONVEX_URL!,
  convexSiteUrl: process.env.VITE_CONVEX_SITE_URL!,
});
```

### 8.B.2 Auth API endpoint

**Create:** `src/routes/api/auth/$.ts`

```ts
import { createFileRoute } from "@tanstack/react-router";
import { handler } from "@/lib/convex/auth/auth-server";

export const Route = createFileRoute("/api/auth/$")({
  server: {
    handlers: {
      GET: ({ request }) => handler(request),
      POST: ({ request }) => handler(request),
    },
  },
});
```

### 8.B.3 Caller/context and providers

Use docs pattern from `tanstack-start.mdx` for:

- `createCallerFactory` + `runServerCall`
- router context values (`convex`, `queryClient`, `convexQueryClient`)
- provider wrapping with `ConvexAuthProvider` and `initialToken`

## 9. Optional Modules Setup (Feature Gates)

Enable only selected modules.

### 9.0 Component composition rule (`convex/functions/convex.config.ts`)

When multiple components are enabled, register all in one `defineApp()` file:

```ts
import aggregate from "@convex-dev/aggregate/convex.config";
import rateLimiter from "@convex-dev/rate-limiter/convex.config";
import resend from "@convex-dev/resend/convex.config";
import { defineApp } from "convex/server";

const app = defineApp();

// Enable only selected components:
app.use(rateLimiter);
app.use(resend);
app.use(aggregate, { name: "aggregateUsers" });
app.use(aggregate, { name: "aggregateTodosByUser" });

export default app;
```

### 9.1 RLS gate

Use `rlsPolicy` on ORM tables, evaluate through ORM context:

```ts
import { convexTable, id, rlsPolicy, text, eq } from "better-convex/orm";

export const secret = convexTable.withRLS(
  "secret",
  {
    ownerId: id("user").notNull(),
    value: text().notNull(),
  },
  (t) => [
    rlsPolicy("read_own", {
      for: "select",
      using: (ctx) => eq(t.ownerId, ctx.viewerId),
    }),
  ]
);
```

### 9.2 Schema triggers gate

```ts
import { convexTable, onChange } from "better-convex/orm";

export const post = convexTable("post", { title: text().notNull() }, () => [
  onChange(async (ctx, change) => {
    if (change.operation === "delete") return;
    // side effects here
  }),
]);
```

### 9.3 Aggregates gate

Install and register component:

```bash
bun add @convex-dev/aggregate
```

```ts
// convex/functions/convex.config.ts
import aggregate from "@convex-dev/aggregate/convex.config";
import { defineApp } from "convex/server";

const app = defineApp();
app.use(aggregate, { name: "aggregatePostLikes" });
export default app;
```

Attach `TableAggregate.trigger()` in schema trigger list.

### 9.4 Rate limiting gate

Install and register component:

```bash
bun add @convex-dev/rate-limiter
```

```ts
// convex/functions/convex.config.ts
import rateLimiter from "@convex-dev/rate-limiter/convex.config";
import { defineApp } from "convex/server";

const app = defineApp();
app.use(rateLimiter);
export default app;
```

Create `convex/lib/rate-limiter.ts` and call guard from mutation middleware using `.meta({ rateLimit: 'scope/action' })`.

### 9.5 Scheduling gate

Create `convex/functions/crons.ts` with `cronJobs()` and use `ctx.scheduler.runAfter/runAt` in mutations/actions for delayed jobs.

### 9.6 HTTP router gate

If REST endpoints are needed, add cRPC route builders and register routers in `convex/functions/http.ts`; consume via `crpc.http.*` client proxies.

### 9.7 Email + Resend gate

Install packages:

```bash
bun add @convex-dev/resend @react-email/components @react-email/render
```

Register component in `convex/functions/convex.config.ts`:

```ts
import resend from "@convex-dev/resend/convex.config";

app.use(resend);
```

Create action for organization invites or transactional mail:

```ts
"use node";

import { Resend } from "@convex-dev/resend";
import { privateAction } from "../lib/crpc";
import { components } from "./_generated/api";

const resendClient = new Resend(components.resend, { testMode: true });
```

Recommended files for this gate:
- `convex/functions/email.tsx`
- `convex/lib/emails/organization-invite.tsx`

## 10. Plugin Setup Modules

Feature gate each plugin independently after auth core.

### 10.1 Admin plugin

Server:

```ts
import { admin } from "better-auth/plugins";

plugins: [
  admin({
    defaultRole: "user",
  }),
];
```

Client:

```ts
import { adminClient } from "better-auth/client/plugins";

plugins: [adminClient()];
```

Schema needs admin fields on `user` + `impersonatedBy` on `session`.

### 10.2 Organizations plugin

Server: add `organization({...})` plugin config.

Client: add `organizationClient({...})` plugin config.

Schema: add `organization`, `member`, `invitation` (+ optional `team`, `teamMember`), and session fields `activeOrganizationId`/`activeTeamId`.

### 10.3 Polar plugin (billing)

For full billing parity, load and apply `references/auth-polar.md`.

Required file set for this plugin path:
- `convex/lib/polar-polyfills.ts`
- `convex/lib/polar-client.ts`
- `convex/lib/polar-helpers.ts`
- `convex/functions/polarCustomer.ts`
- `convex/functions/polarSubscription.ts`
- `convex/shared/polar-shared.ts`

Also include Polar env keys in your typed env helper and/or Convex env:
- `POLAR_ACCESS_TOKEN`
- `POLAR_SERVER`
- `POLAR_PRODUCT_PREMIUM`
- `POLAR_WEBHOOK_SECRET`

## 11. Dev Scripts and CLI Workflow

### 11.1 Dev bootstrap functions (example parity mode)

If you want the same operational model as `example/convex`, create:

- `convex/functions/init.ts`:
  - `privateMutation`
  - `meta({ dev: true })`
  - bootstraps admin users from env
  - optionally schedules/executes seed on first init
- `convex/functions/seed.ts`:
  - `privateMutation` orchestration for sample data creation
- `convex/functions/reset.ts`:
  - `privateAction` reset entrypoint
  - paged deletion via scheduled internal mutation(s)
  - hard dev-only guard

If using this mode, also enforce a central dev guard in cRPC middleware:
- reject `meta.dev` procedures in production.

Recommended scripts:

```json
{
  "scripts": {
    "convex:dev": "convex dev --until-success --run init && better-convex dev",
    "reset": "convex run reset:reset && sleep 5 && convex run init",
    "seed": "convex run seed:seed",
    "sync:jwks": "convex run auth:getLatestJwks | convex env set JWKS",
    "sync:rotate": "convex run auth:rotateKeys | convex env set JWKS"
  }
}
```

CLI commands:

```bash
bunx better-convex dev
bunx better-convex codegen
bunx better-convex env sync
bunx better-convex env sync --auth
bunx better-convex env sync --auth --prod
```

## 12. Final From-Scratch Execution Checklist

1. `convex.json` configured with `functions: convex/functions` and static codegen enabled.
2. `tsconfig.json` has `strictFunctionTypes: false` and `@convex/*` alias.
3. `.env.local` has `NEXT_PUBLIC_CONVEX_URL` and `NEXT_PUBLIC_CONVEX_SITE_URL`.
4. `schema.ts` + `relations` + `withOrm(ctx)` are wired.
5. `crpc.ts` builders exported and app procedures use `ctx.orm`.
6. `better-convex dev` runs and generates `_generated` + `meta.ts`.
7. If auth enabled: `auth.config.ts`, `auth.ts`, `http-polyfills.ts`, `http.ts`, env sync complete.
8. Client `CRPCProvider` + QueryClient + Convex provider are mounted.
9. Framework branch is complete (Next.js or TanStack Start).
10. If using typed envs: `convex/lib/get-env.ts` exists and Convex code reads through `getEnv()`.
11. Optional modules/plugins added only if selected.
12. If multiple components enabled: `convex/functions/convex.config.ts` composes all `app.use(...)` calls in one file.
13. If organizations + invite mail enabled: `email.tsx` + invite template + resend component are wired.
14. If dev bootstrap mode enabled: `init.ts`, `seed.ts`, `reset.ts` exist and scripts call them.
15. No legacy Ents patterns in setup code.

## 13. Troubleshooting Matrix

| Symptom | Likely Cause | Fix |
| --- | --- | --- |
| `@convex/meta` not found | `better-convex dev` not run | Run `bunx better-convex dev` and regenerate metadata |
| HTTP calls fail but queries work | `.site` URL missing or wrong | Set `NEXT_PUBLIC_CONVEX_SITE_URL` correctly |
| Auth works locally but fails in prod | JWKS not synced | Run `convex run auth:getLatestJwks --prod` then `convex env set JWKS --prod` |
| `UNAUTHORIZED` on protected procedures | auth middleware not attaching `userId` | Ensure `getAuth(ctx)` + `getHeaders(ctx)` session lookup is in middleware |
| `ctx.orm` missing in handlers | ORM context not wired in cRPC `.context()` | Ensure `query` + `mutation` both use `withOrm(ctx)` |
| Route auth cookies not set | Missing CORS auth headers | Add `Better-Auth-Cookie` allow/expose headers + credentials |
| TanStack Start auth helper import errors | Using `better-convex/auth-nextjs` in Start app | Use TanStack Start exception with `@convex-dev/better-auth/*` helpers |
| Trigger side effects too slow | Heavy sync work inside trigger | Move heavy work to scheduled actions via `ctx.scheduler` |
| Rate limiter no-op | component not registered in `convex.config.ts` | Add `@convex-dev/rate-limiter` app component |
| Aggregate counts drift | trigger not attached in schema | Attach `aggregate.trigger()` in table extra config |
| Invite emails never send | `@convex-dev/resend` component not registered | Add `app.use(resend)` and wire `functions/email.tsx` |
| Dev reset/seed commands do nothing | `init.ts`/`seed.ts`/`reset.ts` missing or not wired | Add dev bootstrap functions and scripts from Section 11.1 |

## Coverage Matrix

Source coverage mapping used to build this runbook:

| Source                                               | Mapped In Setup                  |
| ---------------------------------------------------- | -------------------------------- |
| `www/content/docs/templates.mdx`                     | Sections 3, 4, 5, 6, 7, 8, 9, 11 |
| `www/content/docs/quickstart.mdx`                    | Sections 3, 4, 5, 12             |
| `www/content/docs/server/setup.mdx`                  | Section 5.3                      |
| `www/content/docs/auth/server.mdx`                   | Sections 6.1 - 6.8               |
| `www/content/docs/auth/client.mdx`                   | Section 7.1                      |
| `www/content/docs/auth/triggers.mdx`                 | Section 6.4, 9.2                 |
| `www/content/docs/react/index.mdx`                   | Sections 7.2 - 7.4               |
| `www/content/docs/nextjs/index.mdx`                  | Section 8.A                      |
| `www/content/docs/tanstack-start.mdx`                | Section 8.B                      |
| `www/content/docs/server/http.mdx`                   | Sections 6.6, 9.6                |
| `www/content/docs/server/server-side-calls.mdx`      | Section 8.A.1, 8.B.3             |
| `www/content/docs/server/advanced/rate-limiting.mdx` | Section 9.4                      |
| `www/content/docs/server/advanced/aggregates.mdx`    | Section 9.3                      |
| `www/content/docs/server/advanced/scheduling.mdx`    | Section 9.5                      |
| `www/content/docs/orm/queries/index.mdx`             | Sections 5, 12                   |
| `www/content/docs/orm/mutations/index.mdx`           | Sections 5, 12                   |
| `www/content/docs/orm/triggers.mdx`                  | Sections 9.2, 9.3                |
| `www/content/docs/orm/rls.mdx`                       | Section 9.1                      |
| `www/content/docs/auth/plugins/admin.mdx`            | Section 10.1                     |
| `www/content/docs/auth/plugins/organizations.mdx`    | Section 10.2                     |
| `www/content/docs/auth/plugins/polar.mdx`            | Section 10.3                     |
| `www/content/docs/cli.mdx`                           | Section 11                       |

### Example Convex Coverage (Recreation Target)

This runbook + references map to `example/convex` as follows:

| Example Group | Primary Setup Section | Additional Reference |
| --- | --- | --- |
| Core infra (`schema.ts`, `orm.ts`, `crpc.ts`, `http.ts`) | Sections 5, 6.6, 9.6 | `orm.md`, `http.md` |
| Shared contracts (`shared/types.ts`, `shared/auth-shared.ts`, `shared/polar-shared.ts`) | Sections 5.4, 10.2, 10.3 | `auth-organizations.md`, `auth-polar.md` |
| Auth core (`auth.config.ts`, `auth.ts`) | Section 6 | `auth.md` |
| Auth plugins (`admin.ts`, `organization.ts`, `polar*`) | Section 10 | `auth-admin.md`, `auth-organizations.md`, `auth-polar.md` |
| Feature modules (`user.ts`, `projects.ts`, `tags.ts`, `todoComments.ts`, `public.ts`, `items/queries.ts`) | Sections 5, 6, 9 | core `SKILL.md`, `orm.md`, `filters.md` |
| HTTP routers (`routers/health.ts`, `routers/todos.ts`, `routers/examples.ts`) | Section 9.6 | `http.md` |
| Aggregates + rate limits (`aggregates.ts`, `lib/rate-limiter.ts`) | Sections 9.3, 9.4 | `aggregates.md`, `orm.md` |
| Scheduling + internals (`todoInternal.ts`, delayed jobs) | Sections 9.5, 11.1 | `scheduling.md` |
| Email + Resend (`functions/email.tsx`, `lib/emails/*`) | Section 9.7 | `auth-organizations.md` |
| Dev bootstrap (`init.ts`, `seed.ts`, `reset.ts`) | Section 11.1 | `testing.md` (for verification) |
| Generated outputs (`functions/_generated/*`, `shared/meta.ts`) | Section 5.5 | n/a (generated by CLI) |
