---
title: Setup
description: Set up cRPC with TanStack Query and real-time subscriptions
---

## Overview

cRPC's client integrates TanStack Query with Convex's real-time WebSocket subscriptions. Queries automatically stay in sync with server data while benefiting from TanStack Query's caching, devtools, and familiar API.

## Installation

```bash
bun add better-convex @tanstack/react-query
```

## Create the cRPC Context

Create a file that exports your cRPC hooks:

```tsx title="src/lib/convex/crpc.tsx"
import { api } from '@convex/_generated/api';
import { meta } from '@convex/meta';
import { createCRPCContext } from 'better-convex/react';

export const { CRPCProvider, useCRPC, useCRPCClient } = createCRPCContext(
  api,
  meta
);
```

<Callout type="info">
`meta` is generated by `better-convex dev`. See [CLI](/docs/cli) for details.
</Callout>

### Exports

- **CRPCProvider** - React context provider for cRPC
- **useCRPC** - Hook returning the cRPC proxy for `queryOptions`/`mutationOptions`
- **useCRPCClient** - Hook returning the raw Convex client

## Create a QueryClient

Configure TanStack QueryClient for Convex real-time.

cRPC sets `staleTime: Infinity` and `refetch*: false` on each query automatically (Convex handles freshness via WebSocket).

```ts title="src/lib/convex/query-client.ts"
import {
  type DefaultOptions,
  defaultShouldDehydrateQuery,
  QueryCache,
  QueryClient,
} from '@tanstack/react-query';
import { isCRPCClientError } from 'better-convex/crpc';
import { toast } from 'sonner';
import SuperJSON from 'superjson';

/** Shared hydration config for SSR (client + server) */
export const hydrationConfig: Pick<DefaultOptions, 'dehydrate' | 'hydrate'> = {
  dehydrate: {
    serializeData: SuperJSON.serialize,
    shouldDehydrateQuery: (query) =>
      defaultShouldDehydrateQuery(query) || query.state.status === 'pending',
    shouldRedactErrors: () => false,
  },
  hydrate: {
    deserializeData: SuperJSON.deserialize,
  },
};

export function createQueryClient() {
  return new QueryClient({
    queryCache: new QueryCache({
      onError: (error) => {
        if (isCRPCClientError(error)) {
          console.log(`[CRPC] ${error.code}:`, error.functionName);
        }
      },
    }),
    defaultOptions: {
      ...hydrationConfig,
      mutations: {
        onError: (err) => {
          const error = err as Error & { data?: { message?: string } };
          toast.error(error.data?.message || error.message);
        },
      },
      queries: {
        retry: (failureCount, error) => {
          // Don't retry CRPC client errors (auth failures)
          if (isCRPCClientError(error)) return false;

          const message =
            error instanceof Error ? error.message : String(error);

          // Retry timeouts
          if (message.includes('timed out') && failureCount < 3) {
            console.warn(
              `[QueryClient] Retrying timed out query (attempt ${failureCount + 1}/3)`
            );
            return true;
          }

          return failureCount < 3;
        },
        retryDelay: (attemptIndex) =>
          Math.min(2000 * 2 ** attemptIndex, 30_000),
      },
    },
  });
}
```

## Provider Setup

### Without Auth

For public-only apps without authentication:

```tsx title="src/lib/convex/convex-provider.tsx"
'use client';

import { QueryClientProvider } from '@tanstack/react-query';
import {
  ConvexProvider,
  ConvexReactClient,
  getQueryClientSingleton,
  getConvexQueryClientSingleton,
} from 'better-convex/react';
import { CRPCProvider } from '@/lib/convex/crpc';
import { createQueryClient } from '@/lib/convex/query-client';

const convex = new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

export function BetterConvexProvider({ children }: { children: React.ReactNode }) {
  return (
    <ConvexProvider client={convex}>
      <QueryProvider>{children}</QueryProvider>
    </ConvexProvider>
  );
}

function QueryProvider({ children }: { children: React.ReactNode }) {
  const queryClient = getQueryClientSingleton(createQueryClient);
  const convexQueryClient = getConvexQueryClientSingleton({
    convex,
    queryClient,
  });

  return (
    <QueryClientProvider client={queryClient}>
      <CRPCProvider convexClient={convex} convexQueryClient={convexQueryClient}>
        {children}
      </CRPCProvider>
    </QueryClientProvider>
  );
}
```

### With Auth

For apps with authentication, use `ConvexAuthProvider` instead of `ConvexProvider`:

```tsx title="src/lib/convex/convex-provider.tsx"
'use client';

import {
  QueryClientProvider,
  useQuery,
} from '@tanstack/react-query';
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';
import { ConvexAuthProvider } from 'better-convex/auth-client';
import {
  ConvexReactClient,
  getConvexQueryClientSingleton,
  getQueryClientSingleton,
  useAuth,
  useAuthStore,
  useSyncSession,
} from 'better-convex/react';
import { useRouter } from 'next/navigation';
import type { ReactNode } from 'react';

import { authClient, useSession } from '@/lib/convex/auth-client';
import { CRPCProvider, useCRPC } from '@/lib/convex/crpc';
import { createQueryClient } from '@/lib/convex/query-client';

const convex = new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

export function BetterConvexProvider({
  children,
  token,
}: {
  children: ReactNode;
  token?: string;
}) {
  const router = useRouter();

  return (
    <ConvexAuthProvider
      authClient={authClient}
      client={convex}
      initialToken={token}
      onMutationUnauthorized={() => router.push('/login')}
      onQueryUnauthorized={() => router.push('/login')}
    >
      <QueryProvider>{children}</QueryProvider>
    </ConvexAuthProvider>
  );
}

function QueryProvider({ children }: { children: ReactNode }) {
  const authStore = useAuthStore();

  const queryClient = getQueryClientSingleton(createQueryClient);
  const convexQueryClient = getConvexQueryClientSingleton({
    authStore,
    convex,
    queryClient,
  });

  return (
    <QueryClientProvider client={queryClient}>
      <CRPCProvider convexClient={convex} convexQueryClient={convexQueryClient}>
        <AuthSync />
        {children}
        <ReactQueryDevtools initialIsOpen={false} />
      </CRPCProvider>
    </QueryClientProvider>
  );
}

/** Sync Better Auth session to Convex and keep user data cached */
function AuthSync() {
  const isAuth = useIsAuth();
  const crpc = useCRPC();
  const session = useSession();

  // Sync Better Auth session to Convex auth store
  useSyncSession(session);

  // Keep user data in cache when authenticated
  useQuery(
    crpc.user.getSessionUser.queryOptions({}, { enabled: isAuth })
  );

  return null;
}
```

Key differences from "Without Auth":
- `ConvexAuthProvider` wraps everything with auth state management
- `useAuthStore()` passes auth state to `getConvexQueryClientSingleton`
- `onQueryUnauthorized` / `onMutationUnauthorized` handle auth failures
- `AuthSync` syncs Better Auth session to Convex and keeps user data cached
- `useSyncSession(session)` is required to sync Better Auth session state to Convex

See [Auth Setup](/docs/auth/setup) for backend configuration.

## Singleton Helpers

cRPC provides singleton helpers to ensure consistent client instances across renders and SSR:

### getQueryClientSingleton

Returns the same QueryClient instance on the client, creates a fresh one during SSR:

```ts
const queryClient = getQueryClientSingleton(createQueryClient);
```

### getConvexQueryClientSingleton

Creates and connects the ConvexQueryClient that bridges TanStack Query with Convex subscriptions:

```ts
const convexQueryClient = getConvexQueryClientSingleton({
  convex,             // ConvexReactClient instance
  queryClient,        // TanStack QueryClient
  unsubscribeDelay,   // Optional: delay before unsubscribing (default: 3s)
});
```

#### unsubscribeDelay

Controls how long subscriptions stay open after unmount. Prevents wasteful unsubscribe/subscribe cycles from React StrictMode and quick back/forward navigation.

| Value | Use Case |
|-------|----------|
| `0` | Unsubscribe immediately (minimal server resources) |
| `3000` (default) | Covers StrictMode + quick "oops" back navigations |
| `10000` | Generous buffer for browsing patterns with frequent back/forward |

<Callout type="info">
Even after unsubscribing, cached data persists for `gcTime` (5 min). On back-navigation, you see cached data instantly while a new subscription fetches any updates.
</Callout>

## ConvexQueryClient

The `ConvexQueryClient` bridges TanStack Query with Convex's real-time subscriptions:

- **Real-time sync** - WebSocket subscriptions update TanStack Query cache
- **Auth-aware queries** - Skips queries marked `auth: 'required'` when unauthenticated
- **Subscription lifecycle** - Subscribes on mount, unsubscribes after delay on unmount

### Caching vs Subscriptions

Unlike traditional REST APIs that use polling, Convex pushes updates via WebSocket. This changes how caching works:

```
┌─────────────────────────────────────────────────────────────────┐
│                    Traditional REST API                         │
│                                                                 │
│  fetch() ──► cache ──► staleTime expires ──► refetch()         │
│                              │                                  │
│                        (pull model)                             │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    Convex + cRPC                                │
│                                                                 │
│  useQuery() ──► WebSocket subscription ──► real-time updates   │
│                        │                          │             │
│                   (push model)            cache always fresh    │
└─────────────────────────────────────────────────────────────────┘
```

**Key QueryClient defaults:**

| Setting | Value | Why |
|---------|-------|-----|
| `staleTime` | `Infinity` | Data is never "stale" - Convex pushes updates via WebSocket |
| `gcTime` | `5 min` | Cached data persists for back-navigation after unmount |
| `refetchOnMount` | `false` | No need to refetch - subscription provides latest data |
| `refetchOnWindowFocus` | `false` | WebSocket already pushed any changes |

### Subscription Lifecycle

WebSocket subscriptions are **decoupled** from cache retention:

```
Mount ──► Subscribe to WebSocket ──► Receive updates ──► Unmount
                                                            │
                                                   Wait unsubscribeDelay (3s)
                                                            │
                                              ┌─────────────┴─────────────┐
                                              │                           │
                                        Re-mount in time           Delay expires
                                              │                           │
                                     Cancel unsubscribe              Unsubscribe
                                     (subscription stays)       (free server resources)
                                                                          │
                                                                  Cache data persists
                                                                     (gcTime: 5 min)
                                                                          │
                                                        ┌─────────────────┴─────────────────┐
                                                        │                                   │
                                                 Re-mount in time                    gcTime expires
                                                        │                                   │
                                                 Instant cached data              Cache cleared
                                                 + new subscription               (fresh fetch)
```

## Migrate from Convex

### What stays the same

- `ConvexReactClient` for WebSocket connection
- Real-time data synchronization

### What's new

**Before (vanilla Convex):**
```tsx
import { ConvexProvider, ConvexReactClient } from 'convex/react';

const convex = new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

<ConvexProvider client={convex}>
  {children}
</ConvexProvider>
```

**After (cRPC):**
```tsx
import { QueryClientProvider } from '@tanstack/react-query';
import {
  ConvexReactClient,
  getQueryClientSingleton,
  getConvexQueryClientSingleton,
} from 'better-convex/react';
import { CRPCProvider } from '@/lib/convex/crpc';

const convex = new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

const queryClient = getQueryClientSingleton(createQueryClient);
const convexQueryClient = getConvexQueryClientSingleton({
  convex,
  queryClient,
});

<QueryClientProvider client={queryClient}>
  <CRPCProvider
    convexClient={convex}
    convexQueryClient={convexQueryClient}
  >
    {children}
  </CRPCProvider>
</QueryClientProvider>
```

Key differences:
- TanStack QueryClient manages caching and devtools
- ConvexQueryClient bridges WebSocket updates to TanStack Query
- Singleton helpers ensure SSR compatibility
- Auth-aware query handling with `ConvexAuthProvider`

## Next steps

<Cards>
  <Card title="Queries" href="/docs/react/queries" />
  <Card title="Mutations" href="/docs/react/mutations" />
  <Card title="Auth Setup" href="/docs/auth/setup" />
</Cards>
