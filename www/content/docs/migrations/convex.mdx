---
title: From Convex
description: Migrate from vanilla Convex to better-convex step by step.
links:
  doc: https://docs.convex.dev/production/best-practices
---

import { InfoIcon } from "lucide-react"

In this guide, we'll explore migrating from vanilla Convex to better-convex. You'll learn to convert functions incrementally, set up middleware, and migrate client hooks while keeping existing code working.

## Overview

Migrate incrementally - better-convex works alongside vanilla Convex. Convert functions one at a time:

| Aspect | What Changes |
|--------|--------------|
| Validators | `v.string()` → `z.string()` |
| Arguments | `args: { ... }` → `.input(z.object({ ... }))` |
| Handler params | `(ctx, args)` → `({ ctx, input })` |
| Errors | `ConvexError` → `CRPCError` with codes |
| Middleware | `customQuery` → `.use()` with `next()` |
| Client hooks | `useQuery(api.x)` → `useQuery(crpc.x.queryOptions({}))` |

Let's migrate step by step.

## Step 1: Install

```bash showLineNumbers
bun add better-convex @tanstack/react-query zod
```

## Step 2: Server Setup

### Create cRPC Builder

```ts title="convex/lib/crpc.ts" showLineNumbers {10-11,16-18}
import { initCRPC } from 'better-convex/server';
import type { DataModel } from '../functions/_generated/dataModel';

const c = initCRPC
  .dataModel<DataModel>()
  .create();

export const publicQuery = c.query;
export const publicMutation = c.mutation;
export const publicAction = c.action;
```

### Context - What Stays the Same

Base context properties work identically:
- `ctx.db` - Database reader/writer
- `ctx.auth` - Authentication
- `ctx.storage` - File storage
- `ctx.scheduler` - Scheduler (mutations only)

### Context - What's New

- **Destructured params**: `{ ctx, input }` instead of `(ctx, args)`
- **Ents support**: `ctx.table()` if configured with `.context()`

## Step 3: Migrate Procedures

### Queries

<Compare>
  <CompareItem title="Before (vanilla Convex)">
    ```ts showLineNumbers {3-4}
    import { query } from 'convex/server';
    import { v } from 'convex/values';

    export const get = query({
      args: { id: v.id('user') },
      handler: async (ctx, args) => {
        return ctx.db.get(args.id);
      },
    });
    ```
  </CompareItem>
  <CompareItem title="After (cRPC)">
    ```ts showLineNumbers {1-3,5-7}
    import { z } from 'zod';
    import { publicQuery } from '../lib/crpc';

    export const get = publicQuery
      .input(z.object({ id: z.string() }))
      .query(async ({ ctx, input }) => {
        return ctx.db.get(input.id);
      });
    ```
  </CompareItem>
</Compare>

### Mutations

<Compare>
  <CompareItem title="Before (vanilla Convex)">
    ```ts showLineNumbers {1-2}
    export const create = mutation({
      args: { name: v.string(), email: v.string() },
      handler: async (ctx, args) => {
        return ctx.db.insert('user', args);
      },
    });
    ```
  </CompareItem>
  <CompareItem title="After (cRPC)">
    ```ts showLineNumbers {1-3}
    export const create = publicMutation
      .input(z.object({ name: z.string(), email: z.string() }))
      .mutation(async ({ ctx, input }) => {
        return ctx.db.insert('user', input);
      });
    ```
  </CompareItem>
</Compare>

### Actions

<Compare>
  <CompareItem title="Before (vanilla Convex)">
    ```ts showLineNumbers {1-2}
    export const sendEmail = action({
      args: { to: v.string(), subject: v.string() },
      handler: async (ctx, args) => {
        await fetch('https://api.email.com/send', { ... });
      },
    });
    ```
  </CompareItem>
  <CompareItem title="After (cRPC)">
    ```ts showLineNumbers {1-3}
    export const sendEmail = publicAction
      .input(z.object({ to: z.string(), subject: z.string() }))
      .action(async ({ ctx, input }) => {
        await fetch('https://api.email.com/send', { ... });
      });
    ```
  </CompareItem>
</Compare>

### Internal Procedures

<Compare>
  <CompareItem title="Before (vanilla Convex)">
    ```ts showLineNumbers {1,3-4}
    import { internalQuery } from 'convex/server';

    export const internal_get = internalQuery({
      args: { id: v.id('user') },
      handler: async (ctx, args) => ctx.db.get(args.id),
    });
    ```
  </CompareItem>
  <CompareItem title="After (cRPC)">
    ```ts showLineNumbers {1-3}
    export const internal_get = publicQuery
      .internal()
      .input(z.object({ id: z.string() }))
      .query(async ({ ctx, input }) => ctx.db.get(input.id));
    ```
  </CompareItem>
</Compare>

### Paginated Procedures

<Compare>
  <CompareItem title="Before (vanilla Convex)">
    ```ts showLineNumbers {2,4-5}
    import { query } from 'convex/server';
    import { paginationOptsValidator } from 'convex/server';

    export const list = query({
      args: { paginationOpts: paginationOptsValidator },
      handler: async (ctx, args) => {
        return ctx.db.query('user').order('desc').paginate(args.paginationOpts);
      },
    });
    ```
  </CompareItem>
  <CompareItem title="After (cRPC)">
    ```ts showLineNumbers {1-5,7-8}
    const UserSchema = z.object({
      id: z.string(),
      name: z.string(),
      email: z.string(),
    });

    export const list = publicQuery
      .paginated({ limit: 20, item: UserSchema })
      .query(async ({ ctx, input }) => {
        return ctx.db.query('user').order('desc').paginate({ cursor: input.cursor, numItems: input.limit });
      });
    ```
  </CompareItem>
</Compare>

The output is automatically typed as `{ continueCursor, isDone, page: User[] }`.

## Step 4: Add Middleware

### Authentication

<Compare>
  <CompareItem title="Before (inline in every function)">
    ```ts showLineNumbers {2-3}
    export const me = query({
      handler: async (ctx) => {
        const identity = await ctx.auth.getUserIdentity();
        if (!identity) throw new Error('Unauthenticated');
        return ctx.db.query('user').filter(q =>
          q.eq(q.field('tokenIdentifier'), identity.tokenIdentifier)
        ).first();
      },
    });
    ```
  </CompareItem>
  <CompareItem title="After (cRPC middleware)">
    ```ts title="convex/lib/crpc.ts" showLineNumbers {1-2,4-10,13}
    import { getSession } from 'better-convex/auth';
    import { CRPCError } from 'better-convex/server';

    export const authQuery = c.query.use(async ({ ctx, next }) => {
      const session = await getSession(ctx);
      if (!session) {
        throw new CRPCError({ code: 'UNAUTHORIZED' });
      }
      const user = await ctx.db.get(session.userId);
      return next({ ctx: { ...ctx, user, userId: user.id } });
    });

    // Use everywhere
    export const me = authQuery.query(async ({ ctx }) => ctx.user);
    ```
  </CompareItem>
</Compare>

<Compare>
  <CompareItem title="Before (convex-helpers customQuery)">
    ```ts showLineNumbers {1,3-10}
    import { customQuery, customCtx } from 'convex-helpers/server/customFunctions';

    const authQuery = customQuery(query, customCtx(async (ctx) => {
      const identity = await ctx.auth.getUserIdentity();
      if (!identity) throw new Error('Unauthenticated');
      const user = await ctx.db.query('user')
        .filter(q => q.eq(q.field('tokenIdentifier'), identity.tokenIdentifier))
        .first();
      return { user };
    }));

    // Usage
    export const me = authQuery({
      args: {},
      handler: async (ctx) => ctx.user,
    });
    ```
  </CompareItem>
  <CompareItem title="After (cRPC middleware)">
    ```ts title="convex/lib/crpc.ts" showLineNumbers {1-2,4-10,13}
    import { getSession } from 'better-convex/auth';
    import { CRPCError } from 'better-convex/server';

    export const authQuery = c.query.use(async ({ ctx, next }) => {
      const session = await getSession(ctx);
      if (!session) {
        throw new CRPCError({ code: 'UNAUTHORIZED' });
      }
      const user = await ctx.db.get(session.userId);
      return next({ ctx: { ...ctx, user, userId: user.id } });
    });

    // Use everywhere
    export const me = authQuery.query(async ({ ctx }) => ctx.user);
    ```
  </CompareItem>
</Compare>

### Middleware Composition

Chain multiple middleware with `.use()`:

```ts showLineNumbers {1,3-4,8-9}
const loggedQuery = c.query.use(async ({ ctx, next }) => {
  console.log('Query started');
  const result = await next({ ctx });
  console.log('Query finished');
  return result;
});

const authLoggedQuery = loggedQuery.use(async ({ ctx, next }) => {
  // Auth check...
  return next({ ctx: { ...ctx, userId } });
});
```

Extend existing middleware with `.pipe()`:

```ts showLineNumbers {1-5}
const adminQuery = authQuery.pipe(async ({ ctx, next }) => {
  if (!ctx.user.isAdmin) {
    throw new CRPCError({ code: 'FORBIDDEN' });
  }
  return next({ ctx });
});
```

### Typed Metadata

**New (typed metadata):**
```ts showLineNumbers {1,3,5-6,8-10}
type Meta = { rateLimit?: number };

const c = initCRPC.dataModel<DataModel>().create<Meta>({ ... });

export const limited = c.query
  .meta({ rateLimit: 100 })
  .use(async ({ ctx, meta, next }) => {
    if (meta.rateLimit) {
      await checkRateLimit(ctx, meta.rateLimit);
    }
    return next({ ctx });
  })
  .query(async ({ ctx }) => { ... });
```

## Step 5: Error Handling

### Server - CRPCError

<Compare>
  <CompareItem title="Before (vanilla Convex)">
    ```ts showLineNumbers
    throw new ConvexError({ message: 'Not found' });
    ```
  </CompareItem>
  <CompareItem title="After (cRPC)">
    ```ts showLineNumbers {1,3-6}
    import { CRPCError } from 'better-convex/server';

    throw new CRPCError({
      code: 'NOT_FOUND',  // Maps to HTTP 404
      message: 'User not found',
      cause: originalError,
    });
    ```
  </CompareItem>
</Compare>

Available codes: `UNAUTHORIZED`, `FORBIDDEN`, `NOT_FOUND`, `BAD_REQUEST`, `CONFLICT`, `INTERNAL_SERVER_ERROR`, etc.

### Client - Error States

<Compare>
  <CompareItem title="Before (vanilla Convex)">
    ```ts showLineNumbers
    try {
      await mutate(args);
    } catch (error) {
      console.error(error.message);
    }
    ```
  </CompareItem>
  <CompareItem title="After (cRPC)">
    ```tsx showLineNumbers {1-6,9}
    const { mutate, error, isError } = useMutation(
      crpc.user.create.mutationOptions({
        onError: (error) => {
          toast.error(error.data?.message ?? 'Failed');
        },
      })
    );

    // Or check error type
    import { isCRPCErrorCode } from 'better-convex/react';

    if (isCRPCErrorCode(error, 'NOT_FOUND')) {
      // Handle 404
    }
    ```
  </CompareItem>
</Compare>

## Step 6: Client Setup

### Provider Setup

```tsx title="src/app/providers.tsx" showLineNumbers {3-7,9,11-12,14-17}
'use client';

import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import {
  ConvexReactClient,
  getQueryClientSingleton,
  getConvexQueryClientSingleton,
} from 'better-convex/react';
import { CRPCProvider } from '@/lib/convex/crpc';

const convex = new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

function createQueryClient() {
  return new QueryClient({
    defaultOptions: { queries: { staleTime: Infinity } },
  });
}

export function Providers({ children }: { children: React.ReactNode }) {
  const queryClient = getQueryClientSingleton(createQueryClient);
  const convexQueryClient = getConvexQueryClientSingleton({
    convex,
    queryClient,
  });

  return (
    <QueryClientProvider client={queryClient}>
      <CRPCProvider
        convexClient={convex}
        convexQueryClient={convexQueryClient}
      >
        {children}
      </CRPCProvider>
    </QueryClientProvider>
  );
}
```

### Create cRPC Context

```tsx title="src/lib/convex/crpc.tsx" showLineNumbers {1-4,6-9}
import { api } from '@convex/api';
import { meta } from '@convex/meta';
import type { Api } from '@convex/types';
import { createCRPCContext } from 'better-convex/react';

export const { CRPCProvider, useCRPC, useCRPCClient } = createCRPCContext<Api>({
  api,
  meta,
  convexSiteUrl: process.env.NEXT_PUBLIC_CONVEX_SITE_URL!,
});
```

### Generate Metadata

```bash showLineNumbers
bunx better-convex dev
```

## Step 7: Migrate Client Hooks

### Queries

<Compare>
  <CompareItem title="Before (vanilla Convex)">
    ```tsx showLineNumbers {1,3-4}
    import { useQuery } from 'convex/react';

    const user = useQuery(api.user.get, { id });
    if (user === undefined) return <div>Loading...</div>;
    ```
  </CompareItem>
  <CompareItem title="After (cRPC)">
    ```tsx showLineNumbers {1-2,4-5}
    import { useQuery } from '@tanstack/react-query';
    import { useCRPC } from '@/lib/convex/crpc';

    const crpc = useCRPC();
    const { data: user, isPending } = useQuery(crpc.user.get.queryOptions({ id }));

    if (isPending) return <div>Loading...</div>;
    ```
  </CompareItem>
</Compare>

**New options:**
```tsx showLineNumbers {2,5,8-10}
// Skip when not authenticated
const { data } = useQuery(crpc.user.me.queryOptions({}, { skipUnauth: true }));

// One-time fetch (no WebSocket subscription)
const { data } = useQuery(crpc.user.get.queryOptions({ id }, { subscribe: false }));

// Placeholder data for skeletons
const { data } = useQuery(crpc.user.get.queryOptions({ id }, {
  placeholderData: { name: 'Loading...', email: '' },
}));
```

### Mutations

<Compare>
  <CompareItem title="Before (vanilla Convex)">
    ```tsx showLineNumbers {1-2}
    const createUser = useMutation(api.user.create);
    await createUser({ name: 'John' });
    ```
  </CompareItem>
  <CompareItem title="After (cRPC)">
    ```tsx showLineNumbers {1-7,9}
    const { mutate, mutateAsync, isPending } = useMutation(
      crpc.user.create.mutationOptions({
        onSuccess: () => toast.success('Created!'),
        onError: (error) => toast.error(error.data?.message ?? 'Failed'),
        onMutate: () => { /* optimistic update */ },
        onSettled: () => { /* cleanup */ },
      })
    );

    mutate({ name: 'John' });
    // or
    await mutateAsync({ name: 'John' });
    ```
  </CompareItem>
</Compare>

### Infinite Queries

<Compare>
  <CompareItem title="Before (vanilla Convex)">
    ```tsx showLineNumbers {1-5,7-8}
    const { results, status, loadMore } = usePaginatedQuery(
      api.user.list,
      {},
      { initialNumItems: 10 }
    );

    const isLoading = status === 'LoadingFirstPage';
    const canLoadMore = status === 'CanLoadMore';
    ```
  </CompareItem>
  <CompareItem title="After (cRPC)">
    ```tsx showLineNumbers {1-2,4-10}
    import { skipToken } from '@tanstack/react-query';
    import { useInfiniteQuery } from 'better-convex/react';

    const {
      data,           // Flattened array (was: results)
      pages,          // Raw page arrays
      isLoading,      // (was: status === 'LoadingFirstPage')
      hasNextPage,    // (was: status === 'CanLoadMore')
      isFetchingNextPage, // (was: status === 'LoadingMore')
      fetchNextPage,  // (was: loadMore)
    } = useInfiniteQuery(
      crpc.user.list.infiniteQueryOptions(enabled ? {} : skipToken)
    );
    ```
  </CompareItem>
</Compare>

## Step 8: Next.js/RSC (Optional)

### Three Server Patterns

**1. `prefetch()` - Fire-and-forget, non-blocking (NEW):**
```tsx showLineNumbers {1,4,6-8,13}
import { prefetch, HydrateClient } from '@/lib/convex/server';

export default async function Page() {
  prefetch(crpc.user.list.queryOptions({}));

  return (
    <HydrateClient>
      <UserList />
    </HydrateClient>
  );
}

// Client uses standard useQuery
function UserList() {
  const { data } = useQuery(crpc.user.list.queryOptions({}));
}
```

**2. `caller` - Direct server calls:**
```tsx showLineNumbers {1,4-5}
import { caller } from '@/lib/convex/server';

export default async function Page() {
  const users = await caller.user.list({});
  return <UserList users={users} />;
}
```

**3. `preloadQuery()` - Awaited, data + hydration:**
```tsx showLineNumbers {1,4,6-10}
import { preloadQuery, HydrateClient } from '@/lib/convex/rsc';

export default async function Page() {
  const users = await preloadQuery(crpc.user.list.queryOptions({}));

  return (
    <HydrateClient>
      <UserList initialData={users} />
    </HydrateClient>
  );
}
```

### HydrateClient Setup

```tsx title="src/lib/convex/server.ts" showLineNumbers {1,4-6}
import { createCallerFactory, createHydrateClient, createPrefetch } from 'better-convex/rsc';
import { api } from '@convex/_generated/api';
import { meta } from '@convex/meta';

export const createCaller = createCallerFactory(api, meta);
export const caller = createCaller();
export const { HydrateClient, prefetch } = createHydrateClient(api, meta);
```

## Quick Reference

| Aspect | Vanilla Convex | better-convex |
|--------|---------------|---------------|
| **Validators** | `v.string()` | `z.string()` |
| **Arguments** | `args: { ... }` | `.input(z.object({ ... }))` |
| **Handler params** | `(ctx, args)` | `({ ctx, input })` |
| **Internal** | `internalQuery()` | `.internal().query()` |
| **Paginated** | `paginationOptsValidator` | `.paginated({ limit, item })` |
| **Errors** | `ConvexError` | `CRPCError` with codes |
| **Middleware** | `customQuery`/`customCtx` | `.use()` with `next()` |
| **Client hooks** | `useQuery(api.x)` | `useQuery(crpc.x.queryOptions({}))` |
| **Loading state** | `data === undefined` | `isPending` |
| **Mutations** | `useMutation(api.x)` | `useMutation(crpc.x.mutationOptions())` |
| **Infinite** | `usePaginatedQuery` | `useInfiniteQuery` |
| **Server calls** | `preloadQuery` | `prefetch`, `caller` |

## Incremental Migration Tips

1. **Keep both patterns** - Vanilla and cRPC functions coexist
2. **Migrate by module** - Convert one file at a time
3. **Start with queries** - Lower risk than mutations
4. **Add middleware last** - After basic migration works
5. **Test as you go** - Each migration is isolated

```ts showLineNumbers {2,3}
// Both work in the same file
export const legacyList = query({ handler: async (ctx) => { ... } });
export const list = publicQuery.query(async ({ ctx }) => { ... });
```

## Next Steps

<Cards>
  <Card title="Server Setup" href="/docs/server/setup" />
  <Card title="React Setup" href="/docs/react" />
  <Card title="Comparison" href="/docs/comparison/convex" />
</Cards>
