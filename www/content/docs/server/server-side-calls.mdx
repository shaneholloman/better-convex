---
title: Server Side Calls
description: Call procedures from server-side code without HTTP overhead
---

## Overview

The caller lets you invoke cRPC procedures directly from server-side code. No HTTP roundtrip - direct function calls with full type safety.

## Environment Setup

The caller requires the Convex **site URL** (for HTTP actions), which is different from the real-time URL:

<Tabs groupId="env" items={["Local", "Cloud"]} persist>
  <Tab value="Local">
    ```bash title=".env.local"
    # WebSocket API (port 3210)
    NEXT_PUBLIC_CONVEX_URL=http://localhost:3210

    # HTTP routes (port 3211)
    NEXT_PUBLIC_CONVEX_SITE_URL=http://localhost:3211
    ```
  </Tab>
  <Tab value="Cloud">
    ```bash title=".env.local"
    # Generated by Convex
    NEXT_PUBLIC_CONVEX_URL=https://your-project.convex.cloud

    # Add manually - replace .cloud with .site
    NEXT_PUBLIC_CONVEX_SITE_URL=https://your-project.convex.site
    ```
  </Tab>
</Tabs>

## Create Caller

### Without Auth

```ts title="src/lib/convex/server.ts"
import { api } from '@convex/api';
import { meta } from '@convex/meta';
import { createCallerFactory } from 'better-convex/server';

export const { createContext, createCaller } = createCallerFactory({
  api,
  convexSiteUrl: process.env.NEXT_PUBLIC_CONVEX_SITE_URL!,
  meta,
});
```

### Better Auth (Next.js)

For Better Auth with Next.js, see [Next.js Setup](/docs/nextjs/setup) which uses `convexBetterAuth` from `better-convex/auth-nextjs`.

### Custom Auth

Use `createCallerFactory` with a custom `getToken` function:

```ts title="src/lib/convex/server.ts"
import { api } from '@convex/api';
import { meta } from '@convex/meta'; // Generated via CLI, see Metadata
import { createCallerFactory } from 'better-convex/server';

export const { createContext, createCaller } = createCallerFactory({
  api,
  convexSiteUrl: process.env.NEXT_PUBLIC_CONVEX_SITE_URL!,
  getToken: async (siteUrl, headers) => {
    // Extract token from headers (implement your auth logic)
    const token = headers.get('authorization')?.replace('Bearer ', '');
    return { token };
  },
  meta,
});
```

## Usage

Create context from headers, then use `ctx.caller`:

```ts
import { createContext } from '@/lib/convex/server';

// Create context from request headers
const ctx = await createContext({ headers: request.headers });

// Query
const users = await ctx.caller.user.list({});

// Query with input
const user = await ctx.caller.user.getById({ id: userId });

// Mutation
const newId = await ctx.caller.user.create({
  name: 'John',
  email: 'john@example.com',
});

// Check auth state
if (!ctx.isAuthenticated) {
  redirect('/login');
}
```

### Hono Middleware

```ts
const ctx = await createContext({ headers: c.req.raw.headers });
const user = await ctx.caller.user.getSessionUser({});
```

### API Routes

```ts
const ctx = await createContext({ headers: request.headers });
const data = await ctx.caller.user.list({});
```

## Migrate from Convex

### What stays the same

- Server-side data fetching concept
- Full type safety for procedure calls

### What's new

**Before (vanilla Convex):**
```ts
import { fetchQuery, fetchMutation } from 'convex/nextjs';
import { api } from '@convex/_generated/api';

const users = await fetchQuery(api.user.list, {});
const id = await fetchMutation(api.user.create, { name: 'John', email: 'john@example.com' });
```

**After (cRPC):**
```ts
import { createContext } from '@/lib/convex/server';

const ctx = await createContext({ headers });
const users = await ctx.caller.user.list({});
const id = await ctx.caller.user.create({ name: 'John', email: 'john@example.com' });
```

Key differences:
- Unified proxy syntax matching client-side usage
- `ctx.isAuthenticated` for auth state
- `createCallerFactory` for reusable context creation
- Built-in auth/token management

## API Reference

### createCallerFactory

Creates a caller factory with token management and retry logic.

```ts
type CreateCallerFactoryOptions<TApi> = {
  api: TApi;
  convexSiteUrl: string;
  auth?: {
    getToken: (
      siteUrl: string,
      headers: Headers,
      opts?: unknown
    ) => Promise<{ token?: string; isFresh?: boolean }>;
    isUnauthorized?: (error: unknown) => boolean;
  };
  meta: CallerMeta;
};
```

Returns `{ createContext, createCaller }`:

```ts
type ConvexContext<TApi> = {
  token: string | undefined;
  isAuthenticated: boolean;
  caller: ServerCaller<TApi>;
};

// createContext: (opts: { headers: Headers }) => Promise<ConvexContext<TApi>>
// createCaller: (ctxFn: () => Promise<ConvexContext<TApi>>) => LazyCaller<TApi>
```

## Next steps

<Cards>
  <Card title="Metadata" href="/docs/server/metadata" />
  <Card title="RSC" href="/docs/nextjs/rsc" />
</Cards>
