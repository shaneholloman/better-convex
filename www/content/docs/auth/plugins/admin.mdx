---
title: Admin
description: Role-based admin features with Better Auth and Convex.
links:
  doc: https://www.better-auth.com/docs/plugins/admin
---

import { InfoIcon } from "lucide-react"

In this guide, we'll explore role-based admin features with better-convex. You'll learn to configure the admin plugin, set up role-based access control, and use admin APIs for user management, banning, and impersonation.

## Overview

Admin features built on [Better Auth's admin plugin](https://www.better-auth.com/docs/plugins/admin):

| Feature | Description |
|---------|-------------|
| Role-based access | Admin/user roles with middleware checking |
| User management | Create, update, delete users |
| Banning | Ban/unban users with expiration |
| Session management | List, revoke user sessions |
| Impersonation | Admin can impersonate users |
| Custom permissions | Granular access control beyond roles |

Let's set up admin features step by step.

## Prerequisites

Ensure you have [Auth Server](/docs/auth/server) set up before adding admin features.

## 1. Server Configuration

Add the admin plugin to your auth options:

```ts title="convex/functions/auth.ts" showLineNumbers {5-12}
import { admin } from 'better-auth/plugins';
import type { GenericCtx } from '../lib/crpc';

const createAuthOptions = (ctx: GenericCtx) =>
  ({
    // ... existing config
    plugins: [
      admin({
        defaultRole: 'user',
        // adminUserIds: ['user_id_1'], // Always admin regardless of role
        // impersonationSessionDuration: 60 * 60, // 1 hour default
        // defaultBanReason: 'No reason',
        // bannedUserMessage: 'You have been banned',
      }),
      // ... other plugins
    ],
  }) satisfies BetterAuthOptions;
```

### Admin Assignment via Environment

Configure admin emails in your environment:

```bash title="convex/.env" showLineNumbers
ADMIN=admin@example.com,other@example.com
```

Assign admin role on user creation:

```ts title="convex/functions/auth.ts" showLineNumbers {5-15}
export const authClient = createClient<DataModel, typeof schema>({
  // ... config
  triggers: {
    user: {
      beforeCreate: async (_ctx, data) => {
        const env = getEnv();
        const adminEmails = env.ADMIN;

        const role =
          data.role !== 'admin' && adminEmails?.includes(data.email)
            ? 'admin'
            : data.role;

        return { ...data, role };
      },
    },
  },
});
```

## 2. Client Configuration

Add the admin client plugin:

```ts title="src/lib/convex/auth-client.ts" showLineNumbers {1,6}
import { adminClient } from 'better-auth/client/plugins';

export const authClient = createAuthClient({
  // ... existing config
  plugins: [
    adminClient(),
    // ... other plugins
  ],
});
```

## 3. Schema

Add admin fields to your user table:

```ts title="convex/functions/schema.ts" showLineNumbers {1-2,4-18}
import { boolean, convexTable, defineSchema, integer, text } from 'better-convex/orm';

export const user = convexTable('user', {
  // ... existing fields
  role: text(), // 'admin' | 'user'
  banned: boolean(),
  banReason: text(),
  banExpires: integer(),
});

export const session = convexTable('session', {
  // ... existing fields
  impersonatedBy: text(), // Admin user ID
});

export const tables = { user, session };
export default defineSchema(tables, { strict: false });
```

## 4. Access Control

### Role Middleware

Add role middleware to your cRPC setup:

```ts title="convex/lib/crpc.ts" showLineNumbers {1-4,7-14,16-24}
type Meta = {
  auth?: 'optional' | 'required';
  role?: 'admin';
  // ...
};

/** Role middleware - checks admin role from meta after auth middleware */
const roleMiddleware = c.middleware<object>(({ ctx, meta, next }) => {
  const user = (ctx as { user?: { role?: string | null } }).user;
  if (meta.role === 'admin' && user?.role !== 'admin') {
    throw new CRPCError({
      code: 'FORBIDDEN',
      message: 'Admin access required',
    });
  }
  return next({ ctx });
});

export const authQuery = c.query
  .meta({ auth: 'required' })
  .use(devMiddleware)
  .use(authMiddleware)
  .use(roleMiddleware);

export const authMutation = c.mutation
  .meta({ auth: 'required' })
  .use(devMiddleware)
  .use(authMiddleware)
  .use(roleMiddleware)
  .use(rateLimitMiddleware);
```

### Role Guard Helper

```ts title="convex/lib/auth/role-guard.ts" showLineNumbers {4-7,8-12}
import { CRPCError } from 'better-convex/server';

export function roleGuard(
  role: 'admin',
  user: { role?: string | null } | null
) {
  if (!user) {
    throw new CRPCError({
      code: 'FORBIDDEN',
      message: 'Access denied',
    });
  }
  if (role === 'admin' && user.role !== 'admin') {
    throw new CRPCError({
      code: 'FORBIDDEN',
      message: 'Admin access required',
    });
  }
}
```

### Custom Access Control

Define granular permissions beyond admin/user roles:

```ts title="convex/shared/permissions.ts" showLineNumbers {1-2,4-7,9-13,15-17}
import { createAccessControl } from 'better-auth/plugins/access';
import { defaultStatements, adminAc } from 'better-auth/plugins/admin/access';

const statement = {
  ...defaultStatements,
  project: ['create', 'read', 'update', 'delete'],
} as const;

export const ac = createAccessControl(statement);

export const admin = ac.newRole({
  ...adminAc.statements,
  project: ['create', 'read', 'update', 'delete'],
});

export const user = ac.newRole({
  project: ['create', 'read'],
});
```

Pass to plugins:

```ts title="convex/functions/auth.ts" showLineNumbers {2,5}
// Server
admin({ ac, roles: { admin, user } })

// Client (src/lib/convex/auth-client.ts)
adminClient({ ac, roles: { admin, user } })
```

## Admin Functions

<Callout icon={<InfoIcon />}>
Function examples use the ORM (`ctx.orm`).
</Callout>

### Check Admin Status

```ts title="convex/functions/admin.ts" showLineNumbers {5,7-14}
import { CRPCError } from 'better-convex/server';
import { zid } from 'convex-helpers/server/zod4';
import { z } from 'zod';
import { authQuery } from '../lib/crpc';

export const checkUserAdminStatus = authQuery
  .meta({ role: 'admin' })
  .input(z.object({ userId: zid('user') }))
  .output(z.object({
    role: z.string().nullish(),
  }))
  .query(async ({ ctx, input }) => {
    const user = await ctx.orm.query.user.findFirst({
      where: { _id: input.userId },
    });
    if (!user) {
      throw new CRPCError({ code: 'NOT_FOUND', message: 'User not found' });
    }
    return {
      role: user.role,
    };
  });
```

### Update User Role

```ts title="convex/functions/admin.ts" showLineNumbers {1-2,6-10,12-16}
export const updateUserRole = authMutation
  .meta({ role: 'admin' })
  .input(z.object({
    role: z.enum(['user', 'admin']),
    userId: zid('user'),
  }))
  .output(z.boolean())
  .mutation(async ({ ctx, input }) => {
    if (input.role === 'admin' && ctx.user.role !== 'admin') {
      throw new CRPCError({
        code: 'FORBIDDEN',
        message: 'Only admin can promote users to admin',
      });
    }

    const targetUser = await ctx.orm.query.user.findFirst({
      where: { _id: input.userId },
    });
    if (!targetUser) {
      throw new CRPCError({ code: 'NOT_FOUND', message: 'User not found' });
    }

    if (targetUser.role === 'admin' && ctx.user.role !== 'admin') {
      throw new CRPCError({
        code: 'FORBIDDEN',
        message: 'Cannot modify admin users',
      });
    }

    await ctx.orm
      .update(user)
      .set({ role: input.role.toLowerCase() })
      .where(eq(user._id, targetUser._id));
    return true;
  });
```

### Grant Admin by Email

```ts title="convex/functions/admin.ts" showLineNumbers {1-2,6-10,12-14}
export const grantAdminByEmail = authMutation
  .meta({ role: 'admin' })
  .input(z.object({
    email: z.string().email(),
    role: z.enum(['admin']),
  }))
  .output(z.object({
    success: z.boolean(),
    userId: zid('user').optional(),
  }))
  .mutation(async ({ ctx, input }) => {
    const existingUser = await ctx.orm.query.user.findFirst({
      where: { email: input.email },
    });
    if (!existingUser) return { success: false };

    await ctx.orm
      .update(user)
      .set({ role: input.role.toLowerCase() })
      .where(eq(user._id, existingUser._id));
    return { success: true, userId: existingUser._id };
  });
```

### List All Users (Paginated)

```ts title="convex/functions/admin.ts" showLineNumbers {1-11,13-14,17-25}
const UserListItemSchema = z.object({
  _id: zid('user'),
  _creationTime: z.number(),
  name: z.string().optional(),
  email: z.string(),
  image: z.string().nullish(),
  role: z.string(),
  isBanned: z.boolean().optional(),
  banReason: z.string().nullish(),
  banExpiresAt: z.number().nullish(),
});

export const getAllUsers = authQuery
  .input(z.object({
    role: z.enum(['all', 'user', 'admin']).optional(),
    search: z.string().optional(),
  }))
	  .paginated({ limit: 20, item: UserListItemSchema.nullable() })
	  .query(async ({ ctx, input }) => {
	    const result = await ctx.orm.query.user.findMany({
	      cursor: input.cursor,
	      limit: input.limit,
	      orderBy: { _creationTime: 'desc' },
	    });

    const enrichedPage = result.page.map((user) => ({
      ...user,
      banExpiresAt: user.banExpires,
      banReason: user.banReason,
      email: user.email ?? '',
      isBanned: user.banned,
      role: user.role ?? 'user',
    }));

    return { ...result, page: enrichedPage };
  });
```

### Dashboard Stats

```ts title="convex/functions/admin.ts" showLineNumbers {1-2,5-15,17-24}
export const getDashboardStats = authQuery
  .meta({ role: 'admin' })
  .output(z.object({
    recentUsers: z.array(z.object({
      _id: zid('user'),
      _creationTime: z.number(),
      image: z.string().nullish(),
      name: z.string().optional(),
    })),
    totalAdmins: z.number(),
    totalUsers: z.number(),
    userGrowth: z.array(z.object({
      count: z.number(),
      date: z.string(),
    })),
  }))
  .query(async ({ ctx }) => {
    const recentUsers = await ctx.orm.query.user.findMany({
      orderBy: { _creationTime: 'desc' },
      limit: 5,
    });

    // Use aggregate for O(log n) user count
    const totalUsers = await aggregateUsers.count(ctx, {
      bounds: {},
      namespace: 'global',
    });

    // Calculate 7-day growth
    const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
    // Requires index('createdAt').on(t.createdAt) on `user`
    const usersLast7Days = await ctx.orm.query.user.findMany({
      where: { createdAt: { gte: sevenDaysAgo } },
      limit: 1000,
    });

    // ... growth calculation logic

    return { recentUsers, totalAdmins, totalUsers, userGrowth };
  });
```

## Client Usage

### React Hooks

```tsx title="src/components/admin-check.tsx" showLineNumbers {1,4-5,7-9}
import { authClient } from '@/lib/convex/auth-client';

function AdminPanel() {
  const { data: session } = authClient.useSession();
  const isAdmin = session?.user?.role === 'admin';

  if (!isAdmin) {
    return <div>Access denied</div>;
  }

  return (
    <div>
      {/* Admin controls */}
    </div>
  );
}
```

### Ban/Unban Users

```tsx showLineNumbers {2-6,9-11}
// Ban user
await authClient.admin.banUser({
  userId: 'user_123',
  banReason: 'Violation of terms',
  banExpiresIn: 60 * 60 * 24 * 7, // 7 days
});

// Unban user
await authClient.admin.unbanUser({
  userId: 'user_123',
});
```

### Session Management

```tsx showLineNumbers {2-4,7-9,12-14}
// List user sessions
const { data: sessions } = await authClient.admin.listUserSessions({
  userId: 'user_123',
});

// Revoke specific session
await authClient.admin.revokeUserSession({
  sessionToken: 'session_token',
});

// Revoke all sessions
await authClient.admin.revokeUserSessions({
  userId: 'user_123',
});
```

### Impersonation

```tsx showLineNumbers {2-4,7}
// Start impersonating user
await authClient.admin.impersonateUser({
  userId: 'user_123',
});

// Stop impersonating
await authClient.admin.stopImpersonating();
```

### User Management

```tsx showLineNumbers {2-8,11-18,21,24,27,30}
// Create user
await authClient.admin.createUser({
  email: 'user@example.com',
  password: 'password',
  name: 'John Doe',
  role: 'user',
});

// List users (with filtering/sorting/pagination)
const { users, total } = await authClient.admin.listUsers({
  searchValue: 'john',
  searchField: 'name',
  limit: 20,
  offset: 0,
  sortBy: 'createdAt',
  sortDirection: 'desc',
});

// Set role
await authClient.admin.setRole({ userId, role: 'admin' });

// Set password
await authClient.admin.setUserPassword({ userId, newPassword });

// Update user
await authClient.admin.updateUser({ userId, data: { name: 'New Name' } });

// Delete user
await authClient.admin.removeUser({ userId });
```

### Permission Checking

```tsx showLineNumbers {2-4,7-10}
// Check if current user has permission (server call)
const { success } = await authClient.admin.hasPermission({
  permissions: { project: ['create', 'update'] },
});

// Check role permission (client-side, no server call)
const canDelete = authClient.admin.checkRolePermission({
  role: 'admin',
  permissions: { project: ['delete'] },
});
```

## API Reference

| Operation | Method | Admin Required |
|-----------|--------|----------------|
| Create user | `authClient.admin.createUser` | Yes |
| List users | `authClient.admin.listUsers` | Yes |
| Set role | `authClient.admin.setRole` | Yes |
| Set password | `authClient.admin.setUserPassword` | Yes |
| Update user | `authClient.admin.updateUser` | Yes |
| Ban user | `authClient.admin.banUser` | Yes |
| Unban user | `authClient.admin.unbanUser` | Yes |
| List sessions | `authClient.admin.listUserSessions` | Yes |
| Revoke session | `authClient.admin.revokeUserSession` | Yes |
| Revoke all sessions | `authClient.admin.revokeUserSessions` | Yes |
| Impersonate | `authClient.admin.impersonateUser` | Yes |
| Stop impersonating | `authClient.admin.stopImpersonating` | Yes |
| Remove user | `authClient.admin.removeUser` | Yes |
| Check permission | `authClient.admin.hasPermission` | No |
| Check role permission | `authClient.admin.checkRolePermission` | No |

<Callout icon={<InfoIcon />}>
Use Convex functions for custom admin operations. Use Better Auth client API for standard operations like user management, banning, and session management.
</Callout>

## Next Steps

<Cards>
  <Card title="Organizations" href="/docs/auth/plugins/organizations" />
  <Card title="Auth Server" href="/docs/auth/server" />
  <Card title="Templates" href="/docs/templates" />
</Cards>
