---
title: Server
description: Set up Better Auth with Convex database adapter.
links:
  doc: https://www.better-auth.com/docs/installation
---

import { InfoIcon } from "lucide-react"

In this guide, we'll set up Better Auth with Convex as the database adapter. You'll configure the auth client, define the schema, register HTTP routes, and sync environment variables.

## Overview

The server setup involves these components:

| Component | Description |
|-----------|-------------|
| Auth config | JWT provider configuration |
| Auth client | Convex adapter with triggers |
| Schema | Auth tables in your app schema |
| HTTP routes | Better Auth endpoints |
| Environment | Secrets and provider credentials |

Let's set it up step by step.

## Prerequisites

We'll start by installing the required packages:

```bash
bun add better-auth@1.4.9 @convex-dev/better-auth better-convex hono
```

<Callout icon={<InfoIcon />}>
Pin `better-auth` to avoid breaking changes. Check [Better Auth releases](https://github.com/better-auth/better-auth/releases) for updates.
</Callout>

## 1. Auth Config

Next, we'll create the auth configuration file. This tells Convex how to validate JWTs using Static JWKS:

```ts title="convex/functions/auth.config.ts" showLineNumbers {4-6}
import { getAuthConfigProvider } from '@convex-dev/better-auth/auth-config';
import type { AuthConfig } from 'convex/server';

export default {
  providers: [getAuthConfigProvider({ jwks: process.env.JWKS })],
} satisfies AuthConfig;
```

## 2. Create Auth Client

Now we'll create the auth client. This connects Better Auth to your Convex database and lets you add triggers for user lifecycle events:

```ts title="convex/functions/auth.ts" showLineNumbers {8,11,14-16,24-29,45-49,54-57,62-69,72-84}
import { betterAuth, type BetterAuthOptions } from 'better-auth';
import { convex } from '@convex-dev/better-auth/plugins';
import { admin } from 'better-auth/plugins';
import { createClient, createApi, type AuthFunctions } from 'better-convex/auth';
import { internal } from './_generated/api';
import type { ActionCtx, MutationCtx, QueryCtx } from './_generated/server';
import type { DataModel } from './_generated/dataModel';
import schema from './schema';
import authConfig from './auth.config';
import { getOrmCtx } from '../lib/orm';
import { registerTriggers } from '../lib/triggers';

type GenericCtx = QueryCtx | MutationCtx | ActionCtx;
const authFunctions: AuthFunctions = internal.auth;
const triggers = registerTriggers();

// Create client with Convex adapter and triggers
export const authClient = createClient<DataModel, typeof schema>({
  authFunctions,
  schema,
  dbTriggers: triggers, // Optional: wrap ctx.db with convex-helpers triggers
  context: getOrmCtx, // Optional: enrich auth mutation + trigger ctx once
  triggers: {
    user: {
      beforeCreate: async (_ctx, data) => {
      // Ensure every user has a username
      const username =
        data.username?.trim() ||
        data.email?.split('@')[0] ||
        `user-${Date.now()}`;

      return { ...data, username };
    },
      onCreate: async (ctx, user) => {
        // Create related records after signup
        await ctx.orm.insert(profiles).values({
          userId: user._id,
          bio: '',
        });
      },
    },
  },
});

// Auth options factory
export const createAuthOptions = (ctx: GenericCtx) =>
  ({
    baseURL: process.env.SITE_URL!,
    database: authClient.httpAdapter(ctx),
    plugins: [
      convex({
        authConfig,
        jwks: process.env.JWKS,
      }),
      admin(),
    ],
    session: {
      expiresIn: 60 * 60 * 24 * 30, // 30 days
      updateAge: 60 * 60 * 24 * 15, // 15 days
    },
    socialProviders: {
      google: {
        clientId: process.env.GOOGLE_CLIENT_ID!,
        clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
      },
    },
    // Fallback for CLI schema generation
    trustedOrigins: [process.env.SITE_URL ?? 'http://localhost:3000'],
  }) satisfies BetterAuthOptions;

// Create auth instance for HTTP routes
export const createAuth = (ctx: GenericCtx) => betterAuth(createAuthOptions(ctx));

// IMPORTANT: Use getAuth for queries/mutations (direct DB access)
export const getAuth = <Ctx extends QueryCtx | MutationCtx>(ctx: Ctx) => {
  return betterAuth({
    ...createAuthOptions(ctx),
    database: authClient.adapter(ctx, createAuthOptions),
  });
};

// Export trigger handlers for Convex
export const {
  beforeCreate,
  beforeDelete,
  beforeUpdate,
  onCreate,
  onDelete,
  onUpdate,
} = authClient.triggersApi();

// Export CRUD functions for Better Auth
export const {
  create,
  deleteMany,
  deleteOne,
  findMany,
  findOne,
  updateMany,
  updateOne,
  getLatestJwks,
  rotateKeys,
} = createApi(schema, createAuth, {
  dbTriggers: triggers, // Optional: same db trigger wrapper
  context: getOrmCtx, // Optional: same context enrichment
  skipValidation: true, // Smaller generated types
});

// Export auth instance for Better Auth CLI
// biome-ignore lint/suspicious/noExplicitAny: Required for CLI
export const auth = betterAuth(createAuthOptions({} as any));
```

<Callout icon={<InfoIcon />}>
Run `npx convex dev` first to generate `internal.auth` types.
</Callout>

## 3. Update Schema

Your database needs tables for users, sessions, accounts, and more. You have two options: generate them automatically or define them manually.

<Tabs groupId="schema" items={["CLI Generate", "Manual"]} persist>
  <Tab value="CLI Generate">
    The easiest approach is to let the Better Auth CLI generate the tables based on your plugins:

    ```bash
    npx @better-auth/cli generate -y --output convex/functions/authSchema.ts --config convex/functions/auth.ts
    ```

    Then import in your schema:

    ```ts title="convex/schema.ts" showLineNumbers {2,5}
    import { defineSchema } from 'convex/server';
    import { authSchema } from './authSchema';

    export default defineSchema({
      ...authSchema,
      // Your other tables
    });
    ```
  </Tab>
  <Tab value="Manual">
    If you prefer full control, define the auth tables directly in your schema:

    ```ts title="convex/functions/schema.ts" showLineNumbers {1-2,4-72}
    import { boolean, convexTable, defineSchema, id, index, integer, text } from 'better-convex/orm';

    export const user = convexTable(
      'user',
      {
        name: text().notNull(),
        email: text().notNull(),
        emailVerified: boolean().notNull(),
        image: text(),
        createdAt: integer().notNull(),
        updatedAt: integer().notNull(),

        // Admin plugin
        role: text(),
        banned: boolean(),
        banReason: text(),
        banExpires: integer(),
      },
      (t) => [index('email').on(t.email)]
    );

    export const session = convexTable(
      'session',
      {
        token: text().notNull(),
        expiresAt: integer().notNull(),
        createdAt: integer().notNull(),
        updatedAt: integer().notNull(),
        ipAddress: text(),
        userAgent: text(),
        userId: id('user').notNull(),

        // Admin plugin
        impersonatedBy: text(),
      },
      (t) => [index('token').on(t.token), index('userId').on(t.userId)]
    );

    export const account = convexTable(
      'account',
      {
        accountId: text().notNull(),
        providerId: text().notNull(),
        userId: id('user').notNull(),
        accessToken: text(),
        refreshToken: text(),
        idToken: text(),
        accessTokenExpiresAt: integer(),
        refreshTokenExpiresAt: integer(),
        scope: text(),
        password: text(),
        createdAt: integer().notNull(),
        updatedAt: integer().notNull(),
      },
      (t) => [index('accountId').on(t.accountId), index('userId').on(t.userId)]
    );

    export const verification = convexTable(
      'verification',
      {
        identifier: text().notNull(),
        value: text().notNull(),
        expiresAt: integer().notNull(),
        createdAt: integer(),
        updatedAt: integer(),
      },
      (t) => [index('identifier').on(t.identifier)]
    );

    export const jwks = convexTable('jwks', {
      publicKey: text().notNull(),
      privateKey: text().notNull(),
      createdAt: integer().notNull(),
    });

    export const tables = { user, session, account, verification, jwks };
    export default defineSchema(tables, { strict: false });
    ```
  </Tab>
</Tabs>

Add custom indexes as needed:

```ts title="convex/schema.ts" showLineNumbers
// Override with custom indexes
user: authSchema.user.index('username', ['username']),
```

## 4. Polyfills (Required)

Convex's runtime environment doesn't include `MessageChannel`, which Better Auth's HTTP handling requires. Create this polyfill file:

```ts title="convex/lib/http-polyfills.ts" showLineNumbers
// polyfill MessageChannel without using node:events
if (typeof MessageChannel === 'undefined') {
  class MockMessagePort {
    onmessage: ((ev: MessageEvent) => void) | undefined;
    onmessageerror: ((ev: MessageEvent) => void) | undefined;

    addEventListener() {}
    close() {}

    dispatchEvent(_event: Event): boolean {
      return false;
    }

    postMessage(_message: unknown, _transfer: Transferable[] = []) {}
    removeEventListener() {}
    start() {}
  }

  class MockMessageChannel {
    port1: MockMessagePort;
    port2: MockMessagePort;

    constructor() {
      this.port1 = new MockMessagePort();
      this.port2 = new MockMessagePort();
    }
  }

  globalThis.MessageChannel =
    MockMessageChannel as unknown as typeof MessageChannel;
}
```

Import this at the top of your HTTP file (before other imports).

## 5. HTTP Routes

Now we'll expose Better Auth's endpoints via HTTP.

- Without Hono: use Convex `httpRouter` + `registerRoutes` (no Hono required).
- With Hono or custom middleware chains: use Hono + `authMiddleware`.

<Tabs groupId="router" items={["cRPC", "Convex", "Hono", ]} persist>
<Tab value="cRPC">
    ```ts title="convex/functions/http.ts" showLineNumbers {1-5,9-18,21}
    import '../lib/http-polyfills';
    import { authMiddleware } from 'better-convex/auth';
    import { createHttpRouter } from 'better-convex/server';
    import { Hono } from 'hono';
    import { cors } from 'hono/cors';
    import { router } from '../lib/crpc';
    import { createAuth } from './auth';

    const app = new Hono();

    // CORS for API routes
    app.use(
      '/api/*',
      cors({
        origin: process.env.SITE_URL!,
        allowHeaders: ['Content-Type', 'Authorization', 'Better-Auth-Cookie'],
        exposeHeaders: ['Set-Better-Auth-Cookie'],
        credentials: true,
      })
    );

    // Better Auth middleware
    app.use(authMiddleware(createAuth));

    export const appRouter = router({
      // Add your routers here
    });

    export default createHttpRouter(app, appRouter);
    ```
  </Tab>
  <Tab value="Convex">
    ```ts title="convex/functions/http.ts" showLineNumbers {1-4,6-13}
    import '../lib/http-polyfills';
    import { registerRoutes } from 'better-convex/auth';
    import { httpRouter } from 'convex/server';
    import { createAuth } from './auth';

    const http = httpRouter();

    registerRoutes(http, createAuth, {
      cors: {
        allowedOrigins: [process.env.SITE_URL!],
      },
    });

    export default http;
    ```
  </Tab>
  <Tab value="Hono">
    ```ts title="convex/functions/http.ts" showLineNumbers {1-4,8-17,20}
    import '../lib/http-polyfills';
    import { authMiddleware } from 'better-convex/auth';
    import { HttpRouterWithHono } from 'better-convex/server';
    import { Hono } from 'hono';
    import { cors } from 'hono/cors';
    import { createAuth } from './auth';

    const app = new Hono();

    // CORS for API routes
    app.use(
      '/api/*',
      cors({
          origin: process.env.SITE_URL!,
          allowHeaders: ['Content-Type', 'Authorization', 'Better-Auth-Cookie'],
          exposeHeaders: ['Set-Better-Auth-Cookie'],
          credentials: true,
      }),
    );

    // Better Auth middleware
    app.use(authMiddleware(createAuth));

    export default new HttpRouterWithHono(app);
    ```
  </Tab>
  
</Tabs>
<Callout icon={<InfoIcon />}>
See [HTTP Router](/docs/server/http) for route examples, webhooks, and streaming.
</Callout>

## 6. Sync Environment Variables

Finally, we need to set up environment variables. Create `convex/.env`:

```bash title="convex/.env" showLineNumbers
SITE_URL=http://localhost:3000
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
```

With Convex dev server running (`npx convex dev`), sync to Convex in another terminal:

```bash
npx better-convex env sync --auth
```

The `--auth` flag auto-generates `BETTER_AUTH_SECRET` and `JWKS` if they don't exist. See [CLI Reference](/docs/cli#env) for more options.

That's it for the basic setup! Your auth is now configured. To rotate keys later (this invalidates all tokens):

```bash
npx convex run auth:rotateKeys | npx convex env set JWKS
```

## Framework Integration

You've set up the Convex backend. Now let's connect your frontend:

<Cards>
  <Card title="React Setup" href="/docs/react#with-auth" description="ConvexAuthProvider setup" />
  <Card title="Next.js Setup" href="/docs/nextjs" description="Server-side rendering + RSC" />
</Cards>

## Key Concepts

Now that you have auth working, let's understand a few important concepts.

### Direct DB Access vs HTTP Adapter

The auth client provides two adapters depending on where you're calling from:

```ts showLineNumbers {2-4,8-10}
// ✅ In queries/mutations: Use getAuth (direct DB access)
export const someQuery = publicQuery
  .query(async ({ ctx }) => {
    const auth = getAuth(ctx);
    const session = await auth.api.getSession({ headers: await getHeaders(ctx) });
  });

// ✅ In HTTP routes/actions: Use createAuth (HTTP adapter)
export const someAction = publicAction
  .action(async ({ ctx }) => {
    const auth = createAuth(ctx);
    // Use for webhooks, external API calls
  });
```

**Why two adapters?**

| Adapter | Used by | Context | Performance |
|---------|---------|---------|-------------|
| `adapter` | `getAuth` | Queries/mutations | Direct DB access, no overhead |
| `httpAdapter` | `createAuth` | HTTP routes/actions | Uses `ctx.run*` internally |

<Callout icon={<InfoIcon />}>
**Performance:** The `httpAdapter` uses `ctx.runQuery`/`ctx.runMutation` internally, which adds **>50ms latency** per call (increasing with app size). Always use `getAuth` with direct DB access in queries and mutations.
</Callout>

### Custom DB Triggers

Want auth CRUD to participate in your Convex DB triggers? Pass your trigger registry directly:

| Use Case | Description |
|----------|-------------|
| User aggregation | Maintain counts when users are created/deleted |
| Custom trigger systems | Projects using convex-helpers triggers |
| Middleware | Add logging, validation, or other cross-cutting concerns |

```ts title="convex/lib/triggers.ts" showLineNumbers {1,4-8}
import { eq } from 'better-convex/orm';
import { Triggers } from 'convex-helpers/server/triggers';
import { DataModel } from '../functions/_generated/dataModel';
import { stats } from '../functions/schema';

const triggers = new Triggers<DataModel>();

// Maintain user count aggregate
triggers.register('user', async (ctx, change) => {
  if (change.operation !== 'insert' && change.operation !== 'delete') return;
  // ... aggregate maintenance using ctx.db / ctx.orm
});

export { triggers };
```

```ts title="convex/functions/auth.ts" showLineNumbers {1,7-8,13-14}
import { triggers } from './lib/triggers';
import { getOrmCtx } from './lib/orm';

export const authClient = createClient({
  // ...
  dbTriggers: triggers,
  context: getOrmCtx,
});

export const { ... } = createApi(schema, createAuth, {
  dbTriggers: triggers,
  context: getOrmCtx,
});
```

Without `dbTriggers`, auth operations use default `ctx.db` writes and won't run your trigger registry.

## Environment Variables

Here's a quick reference for all the environment variables:

| Variable | Description |
|----------|-------------|
| `SITE_URL` | Your app URL (e.g., `http://localhost:3000`) |
| `JWKS` | Auto-generated by `env sync` |
| `BETTER_AUTH_SECRET` | Auto-generated by `env sync` |

Social providers (optional):

| Variable | Description |
|----------|-------------|
| `GOOGLE_CLIENT_ID` | Google OAuth client ID |
| `GOOGLE_CLIENT_SECRET` | Google OAuth client secret |

Run `npx better-convex env sync` to sync all variables to Convex.

## Production Deployment

Your first production deployment will fail authentication because JWKS isn't set yet. Don't worry - here's how to fix it:

**1. Deploy your app to production**

```bash
npx convex deploy --prod
```

Authentication will fail at this point - that's expected.

**2. Generate and set JWKS**

Run from your local machine with Convex CLI authenticated:

```bash
npx convex run auth:getLatestJwks --prod | npx convex env set JWKS --prod
```

This generates new signing keys (if none exist) and sets the JWKS environment variable.

**3. Verify authentication works**

Test a protected endpoint or sign in through your app. Authentication should now succeed.

<Callout icon={<InfoIcon />}>
**Troubleshooting:** If you see "Invalid token signature" errors after deployment, your JWKS may be outdated. Re-run the `getLatestJwks` command to sync.
</Callout>

## Key Rotation

Need to rotate signing keys? Maybe for security compliance or after a suspected compromise:

```bash
npx convex run auth:rotateKeys --prod | npx convex env set JWKS --prod
```

<Callout icon={<InfoIcon />}>
**Warning:** Key rotation invalidates all existing tokens. All users will be logged out and must re-authenticate. Plan rotations during low-traffic periods.
</Callout>

**Rotation checklist:**
- Schedule during low-traffic window
- Notify users about required re-login (optional)
- Run `rotateKeys` command
- Verify authentication works with new keys
- Monitor for authentication errors

## API

### Convex Plugin

The `convex` plugin handles JWT generation, cookie handling, and JWKS endpoints. Here's what you can configure:

| Option | Required | Description |
|--------|----------|-------------|
| `authConfig` | Yes | Your Convex auth config from `convex/auth.config.ts` |
| `jwt` | No | Customize token expiration and payload |
| `jwks` | No | Static JWKS string for faster validation |
| `options` | No | Pass custom `basePath` if using non-default routes |

The simplest setup just needs your auth config:

```ts showLineNumbers
convex({
  authConfig,
})
```

#### Customizing JWT Tokens

By default, JWTs expire after 15 minutes. The default `definePayload` includes all user fields except `id` and `image`, plus the session ID and issued-at timestamp:

```ts showLineNumbers
definePayload: ({ user, session }) => ({
  ...omit(user, ["id", "image"]),
  sessionId: session.id,
  iat: Math.floor(new Date().getTime() / 1000),
});
```

Here's how to customize the expiration and payload - for example, extending to 4 hours and including only specific fields:

```ts showLineNumbers {3-11}
convex({
  authConfig,
  jwt: {
    expirationSeconds: 60 * 60 * 4, // 4 hours
    definePayload: ({ user, session }) => ({
      name: user.name,
      email: user.email,
      role: user.role,
      sessionId: session.id,
    }),
  },
})
```

<Callout icon={<InfoIcon />}>
The `sessionId` and `iat` (issued-at) fields are always added automatically, even if you don't include them in your custom payload.
</Callout>

#### Static JWKS

For best performance, pass your JWKS as an environment variable. This eliminates database lookups during token validation:

```ts showLineNumbers {3}
convex({
  authConfig,
  jwks: process.env.JWKS,
})
```

See [Authentication Flow](/docs/auth#authentication-flow) to understand why this matters.

#### Custom Base Path

If your Better Auth uses a non-default `basePath`, pass the same value here so the JWKS endpoint is configured correctly:

```ts showLineNumbers {3-5}
convex({
  authConfig,
  options: {
    basePath: "/custom/auth/path",
  },
})
```

### getAuthUserIdentity

Returns the full user identity:

```ts showLineNumbers {1,3,5-8}
import { getAuthUserIdentity } from 'better-convex/auth';

const identity = await getAuthUserIdentity(ctx);

if (identity) {
  identity.userId;    // Id<'user'>
  identity.sessionId; // Id<'session'>
  identity.subject;   // string (user ID as string)
}
```

### getAuthUserId

If you just need the user ID:

```ts showLineNumbers {1,3,5-7,10}
import { getAuthUserId } from 'better-convex/auth';

const userId = await getAuthUserId(ctx);

if (!userId) {
  throw new CRPCError({ code: 'UNAUTHORIZED' });
}

// userId is Id<'user'>
const user = await ctx.orm.query.user.findFirst({ where: { _id: userId } });
```

### getSession

Returns the full session document:

```ts showLineNumbers {1,3,5-10}
import { getSession } from 'better-convex/auth';

const session = await getSession(ctx);

if (session) {
  session._id;                  // Id<'session'>
  session.userId;               // Id<'user'>
  session.activeOrganizationId; // Id<'organization'> | null
  session.expiresAt;            // number
}
```

### getHeaders

Need to call an external API with the current session? This builds the headers:

```ts showLineNumbers {1,3-4,7-9}
import { getHeaders } from 'better-convex/auth';

const headers = await getHeaders(ctx);
// Headers { authorization: 'Bearer ...', x-forwarded-for: '...' }

// Use with fetch
const response = await fetch('https://api.example.com', {
  headers,
});
```

## Next Steps

Done! You now have authentication set up. Here's where to go next:

<Cards>
  <Card title="Templates" href="/docs/templates#authts" />
  <Card title="Client" href="/docs/auth/client" />
  <Card title="Triggers" href="/docs/auth/triggers" />
</Cards>
