---
title: Triggers
description: Lifecycle hooks for user and session events.
links:
  doc: https://www.better-auth.com/docs
---

import { InfoIcon } from "lucide-react"

In this guide, we'll explore auth triggers in better-convex. You'll learn to run custom logic when auth data changes, including creating related records on signup, cleaning up on deletion, and validating data before writes.

## Overview

Triggers let you run custom logic when auth data changes:

| Use Case | Description |
|----------|-------------|
| Create related records | When users sign up |
| Clean up data | When users are deleted |
| Validate or transform | Before writes |
| Sync external services | After changes |

Let's explore the available triggers.

## Available Triggers

### Before Triggers

Run **inside the same Convex transaction** before the database write. Can modify data, enforce invariants, or reject the operation.

| Trigger | Description | Return |
|---------|-------------|--------|
| `beforeCreate` | Before inserting a new record | Modified data or `undefined` |
| `beforeUpdate` | Before updating a record | Modified update or `undefined` |
| `beforeDelete` | Before deleting a record | Modified doc or `undefined` |

### After Triggers

Run after the database write. Use for side effects.

| Trigger | Description | Return |
|---------|-------------|--------|
| `onCreate` | After a record is created | `void` |
| `onUpdate` | After a record is updated | `void` |
| `onDelete` | After a record is deleted | `void` |

## Setup

Pass triggers to `createClient`:

```ts title="convex/functions/auth.ts" showLineNumbers {2-4,8-11,14-25}
import { createClient } from 'better-convex/auth';
import { getOrmCtx } from '../lib/orm';
import { registerTriggers } from '../lib/triggers';

const dbTriggers = registerTriggers();

export const authClient = createClient({
  authFunctions: internal.auth,
  schema,
  dbTriggers, // Optional: apply trigger-wrapped db writes to auth CRUD internals
  context: getOrmCtx, // inject ctx.orm once for auth mutation + trigger handlers
  triggers: {
    user: {
      beforeCreate: async (ctx, data) => { /* ... */ },
      onCreate: async (ctx, doc) => { /* ... */ },
      beforeUpdate: async (ctx, doc, update) => { /* ... */ },
      onUpdate: async (ctx, newDoc, oldDoc) => { /* ... */ },
      beforeDelete: async (ctx, doc) => { /* ... */ },
      onDelete: async (ctx, doc) => { /* ... */ },
    },
    session: {
      onCreate: async (ctx, session) => { /* ... */ },
    },
  },
});
```

<Callout icon={<InfoIcon />}>
Context order is `ctx -> dbTriggers.wrapDB(ctx) -> context(ctx)`.
</Callout>

## User Triggers

### beforeCreate

Transform user data before insertion:

```ts showLineNumbers {3-12}
triggers: {
  user: {
    beforeCreate: async (ctx, data) => {
      // Generate unique username
      const username = await generateUniqueUsername(ctx, data.name);

      // Assign admin role based on email
      const role = adminEmails.includes(data.email) ? 'admin' : 'user';

      return {
        ...data,
        username,
        role,
      };
    },
  },
}
```

### onCreate

Create related records after user signup:

```ts showLineNumbers {3-19}
triggers: {
  user: {
    onCreate: async (ctx, user) => {
      // Create default profile
      await ctx.orm.insert(profiles).values({
        userId: user._id,
        bio: '',
        avatar: user.image,
      });

      // Create personal organization
      await ctx.orm.insert(organizations).values({
        name: `${user.name}'s Workspace`,
        ownerId: user._id,
        type: 'personal',
      });

      // Schedule welcome email
      await ctx.scheduler.runAfter(0, internal.emails.sendWelcome, {
        userId: user._id,
        email: user.email,
      });
    },
  },
}
```

### onUpdate

Sync changes to related records:

```ts showLineNumbers {3-16}
triggers: {
  user: {
    onUpdate: async (ctx, newDoc, oldDoc) => {
      // Sync avatar change to profiles
      if (newDoc.image !== oldDoc.image) {
        const profile = await ctx.orm.query.profiles.findFirst({
          where: { userId: newDoc._id },
        });

        if (profile) {
          await ctx.orm
            .update(profiles)
            .set({ avatar: newDoc.image })
            .where(eq(profiles._id, profile._id));
        }
      }
    },
  },
}
```

### onDelete

Clean up related data:

<Callout icon={<InfoIcon />}>
Cascade deletes in triggers are permanent. Test thoroughly and consider soft deletes for critical data.
</Callout>

```ts showLineNumbers {3-20}
triggers: {
  user: {
    onDelete: async (ctx, user) => {
      // Index profiles.userId and organizations.ownerId.
      // Delete user's profiles
      const profilesToDelete = await ctx.orm.query.profiles.findMany({
        where: { userId: user._id },
        limit: 1000,
      });
      for (const profile of profilesToDelete) {
        await ctx.orm.delete(profiles).where(eq(profiles._id, profile._id));
      }

      // Delete user's organizations
      const orgsToDelete = await ctx.orm.query.organizations.findMany({
        where: { ownerId: user._id },
        limit: 1000,
      });
      for (const org of orgsToDelete) {
        await ctx.orm.delete(organizations).where(eq(organizations._id, org._id));
      }
    },
  },
}
```

## Session Triggers

### onCreate

Set default session state:

```ts showLineNumbers {3-18}
triggers: {
  session: {
    onCreate: async (ctx, sessionDoc) => {
      // Set active organization from user's last active
      if (!sessionDoc.activeOrganizationId) {
        const user = await ctx.orm.query.user.findFirst({
          where: { _id: sessionDoc.userId },
        });

        if (user?.lastActiveOrganizationId) {
          await ctx.orm
            .update(session)
            .set({ activeOrganizationId: user.lastActiveOrganizationId })
            .where(eq(session._id, sessionDoc._id));
        }
      }
    },
  },
}
```

## Export Trigger Functions

After configuring triggers, export them from your auth file:

```ts title="convex/functions/auth.ts" showLineNumbers {2-9}
// Export trigger functions for Better Auth adapter
export const {
  beforeCreate,
  beforeDelete,
  beforeUpdate,
  onCreate,
  onDelete,
  onUpdate,
} = authClient.triggersApi();
```

These functions are called by the Better Auth adapter during CRUD operations.

## Type Safety

Triggers are fully typed based on your schema:

```ts showLineNumbers {3-6,9-12,15-18}
triggers: {
  user: {
    // `data` is typed as Infer<Schema['tables']['user']['validator']>
    beforeCreate: async (ctx, data) => {
      data.email; // string
      data.name;  // string | null
      return data;
    },

    // `doc` includes _id and system fields
    onCreate: async (ctx, doc) => {
      doc._id;           // Id<'user'>
      doc._creationTime; // number
      doc.email;         // string
    },

    // `update` is Partial of the validator
    beforeUpdate: async (ctx, doc, update) => {
      update.name;  // string | null | undefined
      update.email; // string | undefined
      return update;
    },
  },
}
```

## Next Steps

<Cards>
  <Card title="Helpers" href="/docs/auth/server#helpers" />
</Cards>
