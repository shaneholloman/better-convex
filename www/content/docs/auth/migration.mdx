---
title: Migration
description: Migrate from @convex-dev/better-auth to better-convex.
links:
  doc: https://github.com/get-convex/better-auth
---

import { InfoIcon } from "lucide-react"

In this guide, we'll migrate from `@convex-dev/better-auth` (the component-based auth package) to `better-convex`. You'll remove the component pattern, update imports, and configure the new trigger system.

## Overview

The main differences between the packages:

| Aspect | @convex-dev/better-auth | better-convex |
|--------|------------------------|---------------|
| Architecture | Convex component pattern | Direct integration |
| Triggers | Not built-in | `triggers: { user, session }` |
| Client Creation | `createClient(components.betterAuth, {...})` | `createClient({ authFunctions, schema })` |
| DB Adapter | `authComponent.adapter(ctx)` | `authClient.adapter()` + `authClient.httpAdapter()` |
| Provider | `ConvexBetterAuthProvider` | `ConvexAuthProvider` |
| React Utils | `AuthBoundary` | `createAuthMutations()`, auth store |

Let's migrate step by step.

## Step 1: Update Dependencies

We'll start by removing the old package and installing better-convex.

```bash
bun remove @convex-dev/better-auth
bun add better-convex
```

<Callout icon={<InfoIcon />}>
Keep `@convex-dev/better-auth` temporarily if you need the `convex` plugin and `getAuthConfigProvider`. These exports are still from `@convex-dev/better-auth`.
</Callout>

## Step 2: Remove Component Pattern

Next, we'll remove the Convex component configuration. This is the biggest architectural change.

**Files to delete:**
- `convex/betterAuth/` folder (entire directory)
- Remove `app.use(betterAuth)` from `convex/convex.config.ts`

**Before** (`convex/convex.config.ts`):
```ts showLineNumbers {2,5}
import { defineApp } from "convex/server";
import betterAuth from "./betterAuth/convex.config";
import resend from "@convex-dev/resend/convex.config";

const app = defineApp();
app.use(betterAuth);  // Remove this line
app.use(resend);

export default app;
```

**After:**
```ts showLineNumbers
import { defineApp } from "convex/server";
import resend from "@convex-dev/resend/convex.config";

const app = defineApp();
app.use(resend);  // Keep other components

export default app;
```

## Step 3: Update auth.config.ts

The auth config stays similar. We just need to ensure we're passing the static JWKS.

**Before:**
```ts showLineNumbers
import { getAuthConfigProvider } from "@convex-dev/better-auth/auth-config";
import type { AuthConfig } from "convex/server";

export default {
  providers: [getAuthConfigProvider()],
} satisfies AuthConfig;
```

**After:**
```ts showLineNumbers {4}
import { getAuthConfigProvider } from "@convex-dev/better-auth/auth-config";
import type { AuthConfig } from "convex/server";

export default {
  providers: [getAuthConfigProvider({ jwks: process.env.JWKS })],
} satisfies AuthConfig;
```

<Callout icon={<InfoIcon />}>
Passing a static JWKS avoids database queries during token verification. Run `npx better-convex env sync --auth` to generate it.
</Callout>

## Step 4: Migrate auth.ts

This is the main migration. We'll replace the component-based client with direct integration.

**Before** (component pattern):
```ts showLineNumbers title="convex/auth.ts" {2,7-10,13,20,25-28}
import { components } from "./_generated/api";
import { createClient, GenericCtx } from "@convex-dev/better-auth";
import { convex } from "@convex-dev/better-auth/plugins";
import authSchema from "./betterAuth/schema";
import authConfig from "./auth.config";
import { betterAuth, type BetterAuthOptions } from "better-auth/minimal";

export const authComponent = createClient<DataModel, typeof authSchema>(
  components.betterAuth,
  { local: { schema: authSchema }, verbose: false }
);

export const createAuthOptions = (ctx: GenericCtx<DataModel>) => ({
  baseURL: process.env.SITE_URL,
  database: authComponent.adapter(ctx),
  // ... plugins and options
});

export const createAuth = (ctx: GenericCtx<DataModel>) =>
  betterAuth(createAuthOptions(ctx));

export const { getAuthUser } = authComponent.clientApi();

export const getCurrentUser = query({
  args: {},
  handler: async (ctx) => {
    return authComponent.safeGetAuthUser(ctx);
  },
});
```

**After** (direct pattern):
```ts showLineNumbers title="convex/functions/auth.ts" {3,8,11-30,33,40-44,47}
import { convex } from "@convex-dev/better-auth/plugins";
import { betterAuth, type BetterAuthOptions } from "better-auth";
import { createApi, createClient, type AuthFunctions } from "better-convex/auth";
import { internal } from "./_generated/api";
import type { DataModel } from "./_generated/dataModel";
import type { ActionCtx, MutationCtx, QueryCtx } from "./_generated/server";
import authConfig from "./auth.config";
import schema from "./schema";

type GenericCtx = QueryCtx | MutationCtx | ActionCtx;

// Reference internal auth functions (generated after first `npx convex dev`)
const authFunctions: AuthFunctions = internal.auth;

// Create the auth client with triggers
export const authClient = createClient<DataModel, typeof schema>({
  authFunctions,
  schema,
  triggers: {
    user: {
      beforeCreate: async (_ctx, data) => {
        // Transform user data before creation
        return data;
      },
      onCreate: async (ctx, user) => {
        // Side effects after user creation
        console.log("User created:", user._id);
      },
    },
    session: {
      onCreate: async (ctx, session) => {
        // Side effects after session creation
      },
    },
  },
});

// Auth options factory
const createAuthOptions = (ctx: GenericCtx) =>
  ({
    baseURL: process.env.SITE_URL!,
    emailAndPassword: { enabled: true },
    socialProviders: {
      github: {
        clientId: process.env.GITHUB_CLIENT_ID!,
        clientSecret: process.env.GITHUB_CLIENT_SECRET!,
      },
    },
    plugins: [
      convex({
        authConfig,
        jwks: process.env.JWKS,
      }),
    ],
    database: authClient.httpAdapter(ctx),
  }) satisfies BetterAuthOptions;

// For queries/mutations: direct DB access
export const getAuth = <Ctx extends QueryCtx | MutationCtx>(ctx: Ctx) =>
  betterAuth({
    ...createAuthOptions(ctx),
    database: authClient.adapter(ctx, createAuthOptions),
  });

// For actions/HTTP routes: HTTP adapter
export const createAuth = (ctx: ActionCtx) =>
  betterAuth(createAuthOptions(ctx));

// Generate internal CRUD functions
export const {
  create,
  deleteMany,
  deleteOne,
  findMany,
  findOne,
  updateMany,
  updateOne,
  getLatestJwks,
  rotateKeys,
} = createApi(schema, createAuth);

// Generate trigger handlers
export const {
  beforeCreate,
  beforeDelete,
  beforeUpdate,
  onCreate,
  onDelete,
  onUpdate,
} = authClient.triggersApi();

// Export for Better Auth CLI
// biome-ignore lint/suspicious/noExplicitAny: Required for CLI
export const auth = betterAuth(createAuthOptions({} as any));
```

**Key changes:**

| Before | After |
|--------|-------|
| `createClient(components.betterAuth, {...})` | `createClient({ authFunctions, schema, triggers })` |
| `authComponent.adapter(ctx)` | Two adapters: `httpAdapter()` and `adapter()` |
| `authComponent.clientApi()` | `createApi()` generates internal functions |
| No triggers | Built-in `triggers: { user, session }` |

<Callout icon={<InfoIcon />}>
**Why two adapters?** Use `httpAdapter(ctx)` for HTTP routes/actions. Use `adapter(ctx, createAuthOptions)` for queries/mutations with direct DB access (better performance).
</Callout>

## Step 5: Update auth-client.ts

Now we'll update the client-side auth setup.

**Before:**
```ts showLineNumbers title="lib/auth-client.tsx"
"use client";

import { convexClient } from "@convex-dev/better-auth/client/plugins";
import { createAuthClient } from "better-auth/react";

export const authClient = createAuthClient({
  plugins: [
    convexClient(),
    // ... other plugins
  ],
});
```

**After:**
```ts showLineNumbers title="lib/convex/auth-client.ts" {3,7-8,15-19}
import { convexClient } from "@convex-dev/better-auth/client/plugins";
import { createAuthClient } from "better-auth/react";
import { createAuthMutations } from "better-convex/react";

export const authClient = createAuthClient({
  baseURL: process.env.NEXT_PUBLIC_SITE_URL!,
  sessionOptions: {
    refetchOnWindowFocus: false,  // Saves HTTP calls on tab focus
  },
  plugins: [
    convexClient(),
    // ... other plugins
  ],
});

// Export mutation hooks for TanStack Query
export const {
  useSignOutMutationOptions,
  useSignInSocialMutationOptions,
  useSignInMutationOptions,
  useSignUpMutationOptions,
} = createAuthMutations(authClient);
```

The new `createAuthMutations` helper generates TanStack Query mutation options for common auth operations.

## Step 6: Update Provider

Replace `ConvexBetterAuthProvider` with `ConvexAuthProvider`.

**Before:**
```tsx showLineNumbers title="app/ConvexClientProvider.tsx" {4,12-17}
"use client";

import { ConvexReactClient } from "convex/react";
import { ConvexBetterAuthProvider } from "@convex-dev/better-auth/react";
import { authClient } from "@/lib/auth-client";

const convex = new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

export function ConvexClientProvider({ children, initialToken }) {
  return (
    <ConvexBetterAuthProvider
      client={convex}
      authClient={authClient}
      initialToken={initialToken}
    >
      {children}
    </ConvexBetterAuthProvider>
  );
}
```

**After:**
```tsx showLineNumbers title="lib/convex/convex-provider.tsx" {4,13-22}
"use client";

import { ConvexReactClient } from "convex/react";
import { ConvexAuthProvider } from "better-convex/auth-client";
import { authClient } from "@/lib/convex/auth-client";
import { useRouter } from "next/navigation";

const convex = new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

export function BetterConvexProvider({ children, token }) {
  const router = useRouter();

  return (
    <ConvexAuthProvider
      authClient={authClient}
      client={convex}
      initialToken={token}
      onMutationUnauthorized={() => {
        router.push("/login");
      }}
      onQueryUnauthorized={({ queryName }) => {
        router.push("/login");
      }}
    >
      {children}
    </ConvexAuthProvider>
  );
}
```

**New features:**
- `onMutationUnauthorized` — Handle auth errors on mutations
- `onQueryUnauthorized` — Handle auth errors on queries (includes `queryName` for debugging)

## Step 7: Remove AuthBoundary

If you were using `AuthBoundary`, you can now handle auth errors via provider callbacks instead.

**Before:**
```tsx showLineNumbers
import { AuthBoundary } from "@convex-dev/better-auth/react";

export const ClientAuthBoundary = ({ children }) => {
  const router = useRouter();
  return (
    <AuthBoundary
      authClient={authClient}
      onUnauth={() => router.push("/sign-in")}
      getAuthUserFn={api.auth.getAuthUser}
      isAuthError={isAuthError}
    >
      {children}
    </AuthBoundary>
  );
};
```

**After:** Remove `AuthBoundary` and use the provider's `onQueryUnauthorized` and `onMutationUnauthorized` callbacks instead (configured in Step 6).

## Step 8: Update Schema

If you were using the auto-generated component schema, you'll now define auth tables in your main schema.

<Tabs groupId="schema" items={["CLI Generate", "Manual"]} persist>
  <Tab value="CLI Generate">
    Generate auth tables using the Better Auth CLI:

    ```bash
    npx @better-auth/cli generate -y --output convex/functions/authSchema.ts --config convex/functions/auth.ts
    ```

    Then import in your schema:

    ```ts title="convex/functions/schema.ts" showLineNumbers {2,5}
    import { defineSchema } from 'convex/server';
    import { authSchema } from './authSchema';

    export default defineSchema({
      ...authSchema,
      // Your other tables
    });
    ```
  </Tab>
  <Tab value="Manual">
    See [Auth Server Setup](/docs/auth/server#3-update-schema) for the full schema definition.
  </Tab>
</Tabs>

## Migration Checklist

- [ ] **Dependencies:** Remove `@convex-dev/better-auth`, install `better-convex`
- [ ] **convex.config.ts:** Remove `app.use(betterAuth)` line
- [ ] **betterAuth folder:** Delete the entire `convex/betterAuth/` directory
- [ ] **auth.config.ts:** Add `jwks: process.env.JWKS` option
- [ ] **auth.ts:** Rewrite using new `createClient` and `createApi` patterns
- [ ] **auth-client.ts:** Add `createAuthMutations`, update imports
- [ ] **Provider:** Replace `ConvexBetterAuthProvider` with `ConvexAuthProvider`
- [ ] **AuthBoundary:** Remove and use provider callbacks
- [ ] **Schema:** Generate or define auth tables in main schema
- [ ] **Env vars:** Run `npx better-convex env sync --auth` for JWKS
- [ ] **Test:** Verify sign-in, sign-up, session persistence, and token refresh

## Troubleshooting

### "Cannot find module 'better-convex/auth'"

Make sure you've installed the package:

```bash
bun add better-convex
```

### "authFunctions is undefined"

Run `npx convex dev` first to generate the internal API, then reference it correctly:

```ts
const authFunctions: AuthFunctions = internal.auth;
```

### "Token not refreshing"

The new provider handles token refresh automatically. If issues persist, check that `onQueryUnauthorized` isn't redirecting before the refresh completes.

### "Triggers not firing"

Triggers must be defined in `createClient`. They only fire through Better Auth flows, not direct database operations.

## Next Steps

Done! Your auth is now migrated. Here's what to explore next:

<Cards>
  <Card title="Triggers" href="/docs/auth/triggers" description="Add user lifecycle hooks" />
  <Card title="Organizations" href="/docs/auth/organizations" description="Multi-tenant support" />
  <Card title="Client Setup" href="/docs/auth/client" description="React hooks and utilities" />
</Cards>
