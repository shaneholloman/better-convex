---
title: Relations
description: Define relationships between tables with Better-Convex ORM
links:
  doc: https://orm.drizzle.team/docs/rqb#declare-relations
---

import { InfoIcon, CheckCircle, AlertTriangle } from "lucide-react"

Define relationships between tables using Drizzle v1 `defineRelations()` API. Better-Convex ORM mirrors Drizzle v1 relation syntax.

## Overview

Relations in Better-Convex ORM use the same API as Drizzle v1 for **defining** and **loading** relationships. The `with:` option is type-safe, with a few nested constraints noted below.

<Callout icon={<AlertTriangle />}>
Relation loading via `with:` works end-to-end. Nested `with` has a depth limit and per-relation filters are post-fetch for `many()` relations.
</Callout>

## Relation Types

### One-to-One Relations

```ts title="convex/schema.ts" showLineNumbers {1-3,5-23}
import { convexTable, defineRelations, text, id } from 'better-convex/orm';

const users = convexTable('users', {
  name: text().notNull(),
});

const profiles = convexTable('profiles', {
  bio: text().notNull(),
  userId: id('users'),
});

const ormSchema = defineRelations({ users, profiles }, (r) => ({
  profiles: {
    user: r.one.users({
      from: r.profiles.userId,
      to: r.users._id,
    }),
  },
  users: {
    profile: r.one.profiles(),
  },
}));
```

<Callout icon={<InfoIcon />}>
**Relation Definition**: Use `from` and `to` to describe the foreign key relationship. In Convex, primary keys are `_id`.
</Callout>

### One-to-Many Relations

The most common relation type - one user has many posts.

```ts title="convex/schema.ts" showLineNumbers {1-3,5-21,23-31}
import { convexTable, defineRelations, text, boolean, id } from 'better-convex/orm';

const users = convexTable('users', {
  name: text().notNull(),
});

const posts = convexTable('posts', {
  title: text().notNull(),
  content: text().notNull(),
  published: boolean(),
  userId: id('users'),
});

const ormSchema = defineRelations({ users, posts }, (r) => ({
  users: {
    posts: r.many.posts(),
  },
  posts: {
    author: r.one.users({
      from: r.posts.userId,
      to: r.users._id,
    }),
  },
}));
```

**Key Points:**
- **Foreign key is on the "many" side**: `posts.userId` references `users._id`
- **Define both sides**: Define relations on both users and posts
- **Export both**: Both table and relations object must be in schema export

### Many-to-Many Relations (Join Table)

Better-Convex does not auto-create join tables. Model many-to-many with an explicit join table:

```ts title="convex/schema.ts" showLineNumbers {1-3,5-24,26-40}
import { convexTable, defineRelations, text, id } from 'better-convex/orm';

const posts = convexTable('posts', {
  title: text().notNull(),
});

const tags = convexTable('tags', {
  name: text().notNull(),
});

const postsTags = convexTable('postsTags', {
  postId: id('posts'),
  tagId: id('tags'),
});

const ormSchema = defineRelations({ posts, tags, postsTags }, (r) => ({
  posts: {
    tags: r.many.postsTags(),
  },
  tags: {
    posts: r.many.postsTags(),
  },
  postsTags: {
    post: r.one.posts({ from: r.postsTags.postId, to: r.posts._id }),
    tag: r.one.tags({ from: r.postsTags.tagId, to: r.tags._id }),
  },
}));
```

### Self-Referencing Relations

Define relations where a table references itself (e.g., user followers).

```ts title="convex/schema.ts" showLineNumbers {1-8}
import { convexTable, defineRelations, text, id } from 'better-convex/orm';

const users = convexTable('users', {
  name: text().notNull(),
  username: text().notNull(),
  managerId: id('users'),
});

const ormSchema = defineRelations({ users }, (r) => ({
  users: {
    manager: r.one.users({
      from: r.users.managerId,
      to: r.users._id,
      alias: 'manager',
    }),
    reports: r.many.users({
      from: r.users._id,
      to: r.users.managerId,
      alias: 'manager',
    }),
  },
}));
```

**Important:**
- **Use `alias`** to distinguish self-referencing relations
- **Unique names** are required to disambiguate

## Relation Definition Rules

### Required Fields

Define the `one()` side with `from` and `to`. The `many()` side can be inferred from the inverse relation.

```ts
const ormSchema = defineRelations({ users, posts }, (r) => ({
  posts: {
    author: r.one.users({
      from: r.posts.userId,
      to: r.users._id,
    }),
  },
  users: {
    posts: r.many.posts(),
  },
}));
```

### Export Tables and Schema

```ts
export const ormSchema = defineRelations({ users, posts }, (r) => ({
  users: { posts: r.many.posts() },
  posts: { author: r.one.users({ from: r.posts.userId, to: r.users._id }) },
}));

export const ormEdges = extractRelationsConfig(ormSchema);
```

### Bidirectional Definitions

Define both sides when you want `with` loading in both directions.

## Relation Loading with `with:`

Better-Convex ORM supports Drizzle-style relation loading:

```ts
import { createDatabase } from 'better-convex/orm';

const db = createDatabase(ctx.db, ormSchema, ormEdges);

const usersWithPosts = await db.query.users.findMany({
  with: {
    posts: {
      limit: 5,
      orderBy: { _creationTime: 'desc' },
    },
  },
});
```

<Callout icon={<InfoIcon />}>
**Note**: `limit`, `orderBy`, and `where` apply to `many()` relations. Nested `with` works with a depth limit to prevent infinite recursion.
</Callout>

## Common Gotchas

| Issue | Solution |
|-------|----------|
| **Relations not working** | Define relations in `defineRelations()` and pass `ormEdges` to `createDatabase` |
| **Foreign key field missing** | Define the FK column yourself (e.g., `userId: id('users')`) |
| **Type errors in `from`/`to`** | Ensure `from` columns belong to the source table and `to` columns belong to the target table |
| **Self-referencing conflicts** | Use unique `alias` for each self-referencing relation |
| **`with:` not working** | Ensure relations are defined on both tables and `ormEdges` is passed to `createDatabase` |

## Next Steps

<Cards>
  <Card title="Querying Data" href="/docs/db/orm/queries">
    Learn findMany(), findFirst(), and filtering
  </Card>
  <Card title="Schema Definition" href="/docs/db/orm/schema">
    Deep dive into table definitions and type inference
  </Card>
  <Card title="Limitations" href="/docs/db/orm/limitations">
    Understand current limitations
  </Card>
  <Card title="Drizzle Comparison" href="/docs/db/orm/comparison">
    See how Better-Convex maps to Drizzle's API
  </Card>
</Cards>
