---
title: Relations
description: Define relationships between tables with Better-Convex ORM
links:
  doc: https://orm.drizzle.team/docs/rqb#declare-relations
---

import { InfoIcon, CheckCircle, AlertTriangle } from "lucide-react"

Define relationships between tables using Drizzle's `relations()` API. Better-Convex ORM uses the exact same relation definition syntax as Drizzle.

## Overview

**Category**: ✅ Drizzle-Compatible (Definition + Loading) | ⚠️ Limited (Nested Constraints)

Relations in Better-Convex ORM use the same API as Drizzle for **defining** and **loading** relationships. The `with:` option is implemented and type-safe, with a few nested constraints noted below.

<Callout icon={<AlertTriangle />}>
**Current Status**: Relation loading via `with:` works end-to-end. Nested `with` has a depth limit and per-relation filters are post-fetch for `many()` relations.
</Callout>

## Relation Types

### One-to-One Relations

```ts title="convex/schema.ts" showLineNumbers {1-3,5-23}
import { convexTable, relations, text, id } from 'better-convex/orm';

const users = convexTable('users', {
  name: text().notNull(),
});

const profiles = convexTable('profiles', {
  bio: text().notNull(),
  userId: id('users'),
});

// Define 1:1 relation (profiles side - has foreign key)
const profilesRelations = relations(profiles, ({ one }) => ({
  user: one(users, {
    fields: [profiles.userId],
    references: [users._id],
  }),
}));

// Define 1:1 relation (users side - optional)
const usersRelations = relations(users, ({ one }) => ({
  profile: one(profiles),
}));
```

<Callout icon={<InfoIcon />}>
**Relation Definition**: The `one()` function declares that a profile belongs to exactly one user. The `fields` and `references` parameters specify the foreign key relationship.
</Callout>

### One-to-Many Relations

The most common relation type - one user has many posts.

```ts title="convex/schema.ts" showLineNumbers {1-3,5-21,23-31}
import { convexTable, relations, text, boolean, id } from 'better-convex/orm';

const users = convexTable('users', {
  name: text().notNull(),
});

const posts = convexTable('posts', {
  title: text().notNull(),
  content: text().notNull(),
  published: boolean(),
  userId: id('users'),
});

// "One" side: User has many posts
const usersRelations = relations(users, ({ many }) => ({
  posts: many(posts),
}));

// "Many" side: Post belongs to one user
const postsRelations = relations(posts, ({ one }) => ({
  author: one(users, {
    fields: [posts.userId],
    references: [users._id],
  }),
}));
```

**Key Points:**
- **Foreign key is on the "many" side**: `posts.userId` references `users._id`
- **Define both sides**: Define relations on both users and posts
- **Export both**: Both table and relations object must be in schema export

### Many-to-Many Relations (Join Table)

Better-Convex does not auto-create join tables. Model many-to-many with an explicit join table:

```ts title="convex/schema.ts" showLineNumbers {1-3,5-24,26-40}
import { convexTable, relations, text, id } from 'better-convex/orm';

const posts = convexTable('posts', {
  title: text().notNull(),
});

const tags = convexTable('tags', {
  name: text().notNull(),
});

const postsTags = convexTable('postsTags', {
  postId: id('posts'),
  tagId: id('tags'),
});

const postsRelations = relations(posts, ({ many }) => ({
  tags: many(postsTags),
}));

const tagsRelations = relations(tags, ({ many }) => ({
  posts: many(postsTags),
}));

const postsTagsRelations = relations(postsTags, ({ one }) => ({
  post: one(posts, { fields: [postsTags.postId], references: [posts._id] }),
  tag: one(tags, { fields: [postsTags.tagId], references: [tags._id] }),
}));
```

### Self-Referencing Relations

Define relations where a table references itself (e.g., user followers).

```ts title="convex/schema.ts" showLineNumbers {1-8}
import { convexTable, relations, text } from 'better-convex/orm';

const users = convexTable('users', {
  name: text().notNull(),
  username: text().notNull(),
});

const usersRelations = relations(users, ({ many }) => ({
  followers: many(users, { relationName: 'user_followers' }),
  following: many(users, { relationName: 'user_following' }),
}));
```

**Important:**
- **Use `relationName`** to distinguish self-referencing relations
- **Unique names** are required to disambiguate

## Relation Definition Rules

### Required Fields

When defining the "many" side of a relation, specify the foreign key field explicitly:

```ts
// ✅ CORRECT: Specify fields and references
const postsRelations = relations(posts, ({ one }) => ({
  author: one(users, {
    fields: [posts.userId],
    references: [users._id],
  }),
}));

// ✅ CORRECT: "One" side doesn't need fields/references
const usersRelations = relations(users, ({ many }) => ({
  posts: many(posts),
}));
```

### Export Both Table and Relations

```ts
// ❌ WRONG: Missing relations export
export const schema = {
  users,
  posts,
  // usersRelations missing!
};

// ✅ CORRECT: Export both
export const schema = {
  users,
  posts,
  usersRelations,
  postsRelations,
};
```

### Bidirectional Definitions

```ts
// ❌ WRONG: Only defining one side
const usersRelations = relations(users, ({ many }) => ({
  posts: many(posts),
}));
// Missing postsRelations!

// ✅ CORRECT: Define both sides
const usersRelations = relations(users, ({ many }) => ({
  posts: many(posts),
}));

const postsRelations = relations(posts, ({ one }) => ({
  author: one(users, {
    fields: [posts.userId],
    references: [users._id],
  }),
}));
```

## Relation Loading with `with:`

Better-Convex ORM supports Drizzle-style relation loading:

```ts
import { createDatabase } from 'better-convex/orm';

const db = createDatabase(ctx.db, ormSchema, ormEdges);

const usersWithPosts = await db.query.users.findMany({
  with: {
    posts: {
      limit: 5,
      orderBy: (posts, { desc }) => desc(posts._creationTime),
    },
  },
});
```

<Callout icon={<InfoIcon />}>
**Note**: `limit`, `orderBy`, and `where` apply to `many()` relations. Nested `with` is supported, with a depth limit to prevent infinite recursion.
</Callout>

## Common Gotchas

| Issue | Solution |
|-------|----------|
| **Relations not working** | Export both the table AND the relations object |
| **Foreign key field missing** | Define the FK column yourself (e.g., `userId: id('users')`) |
| **Type errors in `fields`** | Ensure `fields` match the source table and `references` match the target table |
| **Self-referencing conflicts** | Use unique `relationName` for each self-referencing relation |
| **`with:` not working** | Ensure relations are defined on both tables and `ormEdges` is passed to `createDatabase` |

## Next Steps

<Cards>
  <Card title="Querying Data" href="/docs/db/orm/queries">
    Learn findMany(), findFirst(), and filtering
  </Card>
  <Card title="Schema Definition" href="/docs/db/orm/schema">
    Deep dive into table definitions and type inference
  </Card>
  <Card title="Limitations" href="/docs/db/orm/limitations">
    Understand current limitations and planned features
  </Card>
  <Card title="Drizzle Comparison" href="/docs/db/orm/comparison">
    See how Better-Convex maps to Drizzle's API
  </Card>
</Cards>
